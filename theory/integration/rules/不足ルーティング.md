# 不足ルーティング

## 概要

統合アルゴリズム Phase 4g の規則。Phase 4a〜4f の検証結果に基づき、不足の種類に応じた差し戻しを行う。

## 適用手順

### Step 1: 検証結果の集約

Phase 4a〜4f の検証結果を集約し、不足の種類を分類する。

特に、Step 4e（到達パス検証）の結果と Step 4f（構造的品質診断）の結果を組み合わせて原因を特定する。

### Step 2: 差し戻し先の決定

不足の種類に応じて差し戻し先を決定する。

| 不足の種類 | 差し戻し先 | 対処内容 |
|-----------|-----------|---------|
| 素材不足（記述素の欠如、R(P) の不足） | Phase 1（空間構築） | 記述素の追加、R(P) の関係追加・修正 |
| 構造不足（認知的到達経路の不足、層配置の問題） | Phase 2（質問構造設計） | 認知的到達経路の再設計、ゲート辺の再設計 |
| 質問不足（質問数不足、アノマリー導入質問の不足） | Phase 3（質問生成） | 質問の追加・修正 |

### Step 3: 差し戻しの実行

差し戻し後は当該 Phase から Phase 4 まで再実行する。

## 検証項目と差し戻し先の対応

### 完全性検証（Phase 4a）からの不足

- アノマリー導入質問の不足 → Phase 3
- 完全性の不足（RequiredAnomaly の質問カバレッジ不足） → Phase 3（カバーされないアノマリー記述素を effect に含む質問の追加）

### 多層構造検証（Phase 4c）からの不足

- 層0のアノマリー比率超過 → Phase 2（認知的到達経路の逆算不足）
- ボトルネック超過 → Phase 2（代替経路の設計）
- アノマリーの層分散不足 → Phase 2（アノマリー目標設定の見直し）

### シフト方向検証（Phase 4d）からの不足

- シフト先の不一致 → Phase 3（質問群の設計見直し）
- マージン不足 → Phase 3（resolve 強化のための質問追加）

### 到達パス検証（Phase 4e）からの不足

行き詰まりが検出された場合、Step 4f の構造的品質診断の結果を参照して原因を特定する:

- 前提閉包性の不足（L3-6）が原因候補 → Phase 2（前提を充足する質問経路の再設計）または Phase 1（R(P) の修正）
- 層間連鎖性の不足（L3-7）が原因候補 → Phase 1（R(P) への関係追加）または Phase 2（層配置の見直し）
- 構造的不足なし → シフト方向検証（Phase 4d）の結果を再確認、または閾値設定の見直し

## 収束条件

Phase 4 の検証（特に Step 4e の到達パス検証）が通過すれば反復を終了し、形式化（JSON 変換）に進む。

## 備考

- 反復回数に理論的な上限は設けないが、実用上は 3 回程度の反復で収束することが期待される
- 複数の不足が同時に検出された場合、最も上流の Phase への差し戻しを優先する（Phase 1 > Phase 2 > Phase 3）

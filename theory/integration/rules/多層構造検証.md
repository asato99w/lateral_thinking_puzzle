# 多層構造検証

## 概要

統合アルゴリズム Phase 4c の検証規則。Q(P) の層構造がアノマリーの段階的到達を実現しているかを検証する。

## 前提

- Q(P) が導出済みであること
- 層構造が構築済みであること（build_layer_structure）
- アノマリー質問が特定済みであること

## 検証条件

### 条件 1: 層0のアノマリー比率

層0（前提なしの質問群）に含まれるアノマリー質問の比率が閾値以下であること。

**anomaly_layer0_ratio(P) = |{q ∈ Q(P) | layer(q) = 0 かつ anomaly(q) > 0}| / |{q ∈ Q(P) | anomaly(q) > 0}|**

- anomaly_layer0_ratio(P) ≤ LAYER0_ANOMALY_THRESHOLD（推奨: 0.3）
- 理想的にはアノマリー質問が複数の深い層に分散する
- 層0のアノマリーが多い場合、段階的な発見のプロセスが成立しない

### 条件 2: 十分な層深度

アノマリー質問の初回到達深さが一定以上であること。

**min_anomaly_depth(P) = min({layer(q) | q ∈ Q(P) かつ anomaly(q) > 0})**

- min_anomaly_depth(P) ≥ MIN_ANOMALY_DEPTH（推奨: 2）
- 深さが不足する場合、中間的な認知ステップ（prerequisites の連鎖）が不足している

### 条件 3: ボトルネックの制限

全アノマリーへの経路が単一の質問を通過する構造（ボトルネック）が過度でないこと。

- 全アノマリーへの経路に共通する質問（自身を除く）の数が BOTTLENECK_LIMIT 以下
- ボトルネックが存在するとそこで詰まるリスクが高い
- 複数の独立した経路があることが望ましい

### 条件 4: アノマリーの層分散

アノマリー質問が複数の層にわたって分布していること。

**anomaly_layer_count(P) = |{layer(q) | q ∈ Q(P) かつ anomaly(q) > 0}|**

- anomaly_layer_count(P) ≥ MIN_ANOMALY_LAYERS（推奨: 2）
- 一箇所に集中している場合、tension の段階的蓄積が実現しない

## 計測

paradigm_qp.py（derive_qp, build_layer_structure, count_anomalies）で計測可能。

## 不充足時の対処

- 条件 1, 2 の不充足 → Phase 2（質問構造設計）へ差し戻し。認知的到達経路の逆算が不足している
- 条件 3 の不充足 → Phase 2 で代替経路を設計する
- 条件 4 の不充足 → Phase 2 でアノマリー目標設定を見直す

## 備考

- 本規則は Q(P) 構造分析の適用結果（アノマリーの層0集中問題）から導出された
- P_final（最終パラダイム）にはアノマリーがないため、本規則の検証対象外とする

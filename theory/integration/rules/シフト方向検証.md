# シフト方向検証

## 概要

統合アルゴリズム Phase 4d の検証規則。メインパスの各遷移 P_i → P_{i+1} およびサブパラダイムからの遷移について、シフト方向が構造的に保証されているかを検証する。

P_pred の比較による静的分析を主軸とし、シミュレーションによる動的検証で補完する。

## 前提

- パラダイム群（メインパス、サブパラダイム）が決定済みであること
- 各パラダイムの内部構造（P_pred, R(P)）が構成済みであること
- 質問群が生成済みであること
- 近傍・N(P) が計算済みであること

## 検証の 2 層構造

| 層 | 手法 | 対象 | 検出できるもの |
|---|---|---|---|
| 静的分析 | P_pred の比較 | 質問集合の構造 | 方向の偏り、スキップリスク、駆動力の不足 |
| 動的検証 | シミュレーション | 特定回答順序での結果 | シフト先の一致、resolve の充足 |

静的分析で構造的な問題を検出し、動的検証で最終的な挙動を確認する。静的分析で問題がある場合、動的検証の結果に関わらず質問設計の見直しが必要である。

## Step 1: 静的分析（遷移駆動集合）

### 質問レベルの量

各質問 q ∈ Q(P_i) について、effect(q) の各記述素 (d, v) を P_i / P_{i+1} の P_pred と比較する。

- **anomaly_count(q)** = |{(d,v) ∈ effect(q) | P_i.P_pred(d) ≠ None かつ P_i.P_pred(d) ≠ v}|
- **support(q)** = |{(d,v) ∈ effect(q) | P_{i+1}.P_pred(d) = v}|
- **oppose(q)** = |{(d,v) ∈ effect(q) | P_{i+1}.P_pred(d) ≠ None かつ P_{i+1}.P_pred(d) ≠ v}|
- **net_direction(q)** = support(q) - oppose(q)

### 質問の 4 分類

anomaly_count と net_direction の 2 軸で分類する。

| | net_direction > 0 | net_direction ≤ 0 |
|---|---|---|
| **anomaly_count > 0** | 遷移駆動 | 駆動・逆方向 |
| **anomaly_count = 0** | 方向支持 | 中立 |

- **遷移駆動**: P_i を壊しつつ P_{i+1} を支持する。理想的な質問
- **駆動・逆方向**: P_i を壊すが P_{i+1} に向かわない。別パラダイムへのシフトリスク
- **方向支持**: tension には寄与しないが P_{i+1} の方向を支持する
- **中立**: 遷移 (P_i, P_{i+1}) に寄与しない

### 集合レベルの指標

**遷移方向スコア(P_i, P_{i+1})** = Σ net_direction(q) / Σ (support(q) + oppose(q))　（全 q ∈ Q(P_i)）

- +1 に近い: Q(P_i) が全体的に P_{i+1} 方向
- 0 付近: 支持と不支持が拮抗
- 負: P_{i+1} と逆方向に偏っている

**駆動率(P_i, P_{i+1})** = |遷移駆動| / (|遷移駆動| + |駆動・逆方向|)

- 高い: アノマリーに遭遇するたびに自然に P_{i+1} へ向かう
- 低い: アノマリーが P_{i+1} 以外のパラダイムを支持するリスク

### 検証条件（静的）

#### 条件 S1: 遷移方向スコアの正値

遷移方向スコア(P_i, P_{i+1}) > 0 であること。負の場合、Q(P_i) が構造的に P_{i+1} と逆方向に偏っている。

#### 条件 S2: 駆動率

駆動率(P_i, P_{i+1}) > 0.5 であること。低い場合、アノマリー質問の多くが P_{i+1} 以外の方向を支持しており、シフト方向が不安定。

#### 条件 S3: 遷移の十分性

|遷移駆動| が十分であること。遷移駆動集合のサイズが不足すると、特定の質問が選ばれなければ正しい方向への遷移が起きない。

#### 条件 S4: スキップリスクの抑制

メインパスの各遷移 P_i → P_{i+1} において、全候補パラダイムへの方向スコアを比較する。

- 隣接遷移先 P_{i+1} の方向スコアが、非隣接パラダイム（P_{i+2} 以降）の方向スコアを下回る場合、スキップリスクがある
- サブパラダイムの方向スコアが P_{i+1} を上回る場合、サブパラダイムへの逸脱リスクがある

スキップリスクが検出された場合、P_{i+1} 固有の引力を強化する（P_{i+1} の P_pred にしかない記述素に関する質問の追加等）か、質問の所属パラダイム・prerequisite による動的制御で対処する。

### サブパラダイムの検証

サブパラダイム S から全候補パラダイムへの方向スコアを算出し、以下を確認する。

- 遷移先が意図したパラダイムに向いていること
- メインパスへの復帰方向が確保されていること

## Step 2: 動的検証（シミュレーション）

静的分析が通過した後、特定の回答順序でのシフト挙動を確認する。

### Step 2-1: P_i フェーズのシミュレーション

1. ゲーム状態を P_i がアクティブな初期状態に設定する
2. Q(P_i) 内の質問を順に回答する（safe 質問から開始、anomaly 質問は発掘順に回答）
3. 各回答後の tension・resolve の変化を追跡する

### Step 2-2: シフト候補の評価

各回答後に、シフト候補条件を評価する:

1. **近傍**: P' ∈ neighbors(P_i)
2. **tension strict `<`**: tension(O, P') < tension(O, P_i)
3. **resolve >= N**: resolve(O, P_i, P') >= N(P')

3条件を全て満たす候補が出現した時点がシフト発動時点である。

### Step 2-3: 方向検証

候補の中で resolve DESC → attention DESC → pid ASC の優先順位で選択された P_new が、想定する P_{i+1} と一致することを検証する。

### 検証条件（動的）

#### 条件 D1: シフト先の一致

想定する P_{i+1} がシフト先選択の結果と一致すること。

#### 条件 D2: resolve のマージン

P_{i+1} の resolve が N(P_{i+1}) に対して十分なマージンを持つこと。マージンが小さい場合、質問の回答順序によってシフト先が変わるリスクがある。

#### 条件 D3: 候補への含有

P_{i+1} が候補集合に含まれること（3条件を全て満たすこと）。

## 不充足時の対処

### 静的分析の不充足

| 条件 | 対処 |
|---|---|
| S1（方向スコア負） | Phase 3 へ差し戻し。Q(P_i) の質問が P_{i+1} の P_pred と整合する記述素を十分に含んでいない |
| S2（駆動率低） | Phase 3 へ差し戻し。アノマリー質問の effect が P_{i+1} を支持するよう質問を再設計する |
| S3（遷移駆動不足） | Phase 3 へ差し戻し。P_i にアノマリーを生みつつ P_{i+1} を支持する質問を追加する |
| S4（スキップリスク） | Phase 1 または Phase 3 へ差し戻し。P_{i+1} 固有の引力強化または所属パラダイム/prerequisite による動的制御 |

### 動的検証の不充足

| 条件 | 対処 |
|---|---|
| D1（シフト先不一致） | 質問群の設計を見直す。P_i フェーズの質問が resolve を P_{i+1} 方向に蓄積していない |
| D2（マージン不足） | P_i フェーズの質問を追加し、P_{i+1} への resolve を強化する |
| D3（候補非含有） | 近傍関係・N(P) の設定を確認する。resolve が N に届く質問パスが存在するか検証する |

## 2 軸による診断

| 遷移方向スコア | 駆動率 | 診断 |
|---|---|---|
| 高 | 高 | 頑健な遷移。質問選択に依存せず P_{i+1} に向かう |
| 高 | 低 | 方向は正しいがシフト発動が不安定 |
| 低 | 高 | シフトは起きるが方向が拮抗している |
| 低 | 低 | 遷移が脆弱。質問設計の見直しが必要 |

## 実装

- **静的分析**: transition_drive.py（app/poc/scripts/eval/metric/shift/）
- **動的検証**: shift_direction.py（app/poc/scripts/eval/check/）

# シフト方向検証

## 概要

統合アルゴリズム Phase 4d の検証規則。共有質問・架橋質問の廃止に伴い、パラダイムシフトの方向制御をシフトごとのシミュレーションとして検証する。

## 背景

旧来の設計では、質問を「共有質問」（方向づけ）と「架橋質問」（推進力）に事前分類することでシフト方向を制御しようとしていた。しかし、シフト方向は質問の静的な属性ではなくシフト時点での O と H の状態として現れるため、質問の事前分類ではなくシミュレーションで検証すべきである。

## 前提

- パラダイム群（メインパス）が決定済みであること
- 各パラダイムの内部構造（P_pred, Conceivable, R(P)）が構成済みであること
- 質問群が生成済みであること

## 検証手順

メインパスの各遷移 P_i → P_{i+1} について以下を実行する。

### Step 1: P_i フェーズのシミュレーション

1. ゲーム状態を P_i がアクティブな初期状態に設定する
2. Q(P_i) 内の質問を順に回答する（safe 質問から開始、anomaly 質問は発掘順に回答）
3. 各回答後の H の変化を追跡する
4. tension(O, P_i) > threshold(P_i) となる時点を記録する

### Step 2: シフト時点での alignment 計算

tension > threshold 時点での H に対し、全候補パラダイムの alignment を計算する。

**候補 = { P' | explained_o(O, P') > explained_o(O, P_i) }**

各候補について:
- alignment(H, P') を計算する

### Step 3: 方向検証

**P_{i+1} = argmax_{P' ∈ 候補} alignment(H, P')**

であることを検証する。

## 検証条件

### 条件 1: シフト先の一致

想定する P_{i+1} がシフト先選択の結果と一致すること。

### 条件 2: マージン

P_{i+1} の alignment と次点候補の alignment の差が十分であること（推奨: 差 > 0.05）。マージンが小さい場合、質問の回答順序によってシフト先が変わるリスクがある。

### 条件 3: 候補への含有

P_{i+1} が候補集合に含まれること（explained_o(O, P_{i+1}) > explained_o(O, P_i)）。

## 不充足時の対処

- 条件 1 の不充足 → 質問群の設計を見直す。P_i フェーズの質問が H を P_{i+1} 方向に動かしていない
- 条件 2 の不充足 → P_i フェーズの質問を追加し、P_{i+1} との alignment を強化する
- 条件 3 の不充足 → eo ドライバー記述素の到達性を確認する（シフトドライバーの到達性検査と連携）

## 実装

shift_direction.py（app/poc/scripts/eval/check/）で実装。engine.py の compute_effect, _assimilate_descriptor, tension, alignment, explained_o を使用する。

## 備考

- 本規則は共有質問・架橋質問の廃止に伴う代替として設計された
- shift_path.py（テーマ2: シフト先選択の到達性検証）は O* ベースの静的検証であるのに対し、本規則はゲーム進行をシミュレーションする動的検証である
- シミュレーションの質問回答順序は検証結果に影響しうるが、全順序の網羅は現実的でないため、safe→anomaly の基本順序で検証する

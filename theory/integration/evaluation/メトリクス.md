# メトリクス

## 概要

統合アルゴリズムの成果物（サンプル・データ）を評価するためのメトリクス定義。3層に分類する。

| 層 | 名称 | 性質 | 目的 |
|---|---|---|---|
| L1 | 機構メトリクス | エンジンが内部で計算する量 | シフト判定・状態管理に使用 |
| L2 | 検証条件 | OK/NG の合否判定 | 成果物の最低品質を保証 |
| L3 | 品質メトリクス | 連続値の定量評価 | 成果物間の比較・品質向上 |

L1 はエンジンの動作を定義する量であり、評価対象ではない。L2・L3 が評価スクリプトの対象となる。

## L1: 機構メトリクス

エンジン（engine.py, threshold.py）が内部で計算する量。データ設計の前提として理解が必要だが、スクリプトで「良い/悪い」を判定する対象ではない。

| メトリクス | 定義 | 用途 |
|-----------|------|------|
| tension(O, P) | \|Anomaly(O, P)\| | シフト条件の判定 |
| resolve(O, P_c, P_t) | P_c のアノマリーのうち P_t が正しく予測する数 | シフト条件 (resolve >= N) |
| attention(O, P_c, P_t) | P_c のアノマリーのうち P_t の判定域に含まれる数 | 候補優先順位（resolve 同点時） |
| explained_o(O, P) | O のうち P が正しく予測する数 | depth 導出 |
| alignment(H, P) | 判定域での正規化適合度 | 診断指標（シフト選択には不使用） |
| N(P_target) | min over neighbor sources of resolve(O*, P_i, P_target) | シフト閾値 |
| neighbors | O* のもとでの Remaining 集合包含関係 | シフト候補の前提条件 |
| depth | Explained 集合の包含関係から導出 | パラダイム順序 |

## L2: 検証条件

Phase 4 の合否判定に対応する。全条件を通過することが成果物の最低要件。

### L2-0: 到達性

O* のもとで init_paradigm から T に至るシフト連鎖が存在すること。

**定義**: select_shift_target を O* で繰り返し適用し、init_paradigm から T に到達するパスが存在する。

**判定**: OK（到達可能） / NG（到達不可）

### L2-1: 完全性（Phase 4a/4b）

各パラダイム P（T を除く）の全アノマリー記述素が Q(P) のいずれかの質問の effect でカバーされること。

**定義**: {d ∈ 判定域(P) | P_pred(P, d) ≠ T(d)} の全要素について、d を effect に含む質問 q ∈ Q(P) が存在する。

**判定**: OK（全カバー） / NG（未カバーあり）

### L2-2: 同化接続性（Phase 4a/4b）

各近傍ペア (P, P') について、P から P' へシフトした直後に Consistent/Anomaly から R(P') 経由でターゲット記述素に到達でき、そのターゲットを effect に含む未回答質問が存在すること。

**対象**: {(P, P') | P' ∈ neighbors(P)}

**定義**: T_reach = reachable(Consistent(O_P, P'), P') ∪ reachable(Anomaly(O_P, P'), P') の各 t について、t を effect に含む未回答質問が存在する。

**判定**: 各ペアにつき OK / NG

### L2-3: 発掘連鎖（Phase 4a/4b）

ゲーム進行シミュレーションで、初期オープンから質問の開放が順序的に成立し、全パラダイムのアノマリーが発掘されること。

**判定**: OK（全アノマリー発掘） / NG（未発掘あり）

### L2-4: 多層構造（Phase 4c）

各パラダイムの Q(P) の層構造について、以下の 4 条件を満たすこと。

| 条件 | 定義 | 閾値 |
|------|------|------|
| 層0アノマリー比率 | \|{q ∈ Q(P) \| layer(q)=0, anomaly(q)>0}\| / \|{q ∈ Q(P) \| anomaly(q)>0}\| | ≤ 0.3 |
| ボトルネック | 全アノマリー経路に共通する質問数 | ≤ BOTTLENECK_LIMIT |
| アノマリー層分散 | \|{layer(q) \| q ∈ Q(P), anomaly(q)>0}\| | ≥ 2 |

**判定**: 各条件につき OK / NG

### L2-5: シフト方向（Phase 4d — 動的検証）

L2-0 で存在が確認された到達パスの各遷移 P_i → P_{i+1} について、Q(P_i) を回答した際に select_shift_target が P_{i+1} を選択すること。到達パスは一意とは限らない。

| 条件 | 内容 |
|------|------|
| D1: シフト先一致 | select_shift_target の結果が P_{i+1} |
| D2: resolve マージン | resolve(O, P_i, P_{i+1}) - N(P_{i+1}) が十分 |
| D3: 候補含有 | P_{i+1} が候補集合に含まれる |

**判定**: 各条件につき OK / NG

## L3: 品質メトリクス

検証条件を超えた定量的品質評価。成果物間の比較や改善の方向づけに使用する。

### L3-1: 遷移方向スコア（Phase 4d — 静的分析）

**定義**: 遷移方向スコア(P_i, P_{i+1}) = Σ net_direction(q) / Σ (support(q) + oppose(q))

- 範囲: [-1, +1]
- +1 に近い: Q(P_i) が全体的に P_{i+1} 方向
- 条件 S1: > 0 であること

### L3-2: 駆動率（Phase 4d — 静的分析）

**定義**: 駆動率(P_i, P_{i+1}) = |遷移駆動| / (|遷移駆動| + |駆動・逆方向|)

- 範囲: [0, 1]
- 高い: アノマリー遭遇時に自然に P_{i+1} へ向かう
- 条件 S2: > 0.5 であること

### L3-3: 質問 4 分類分布（Phase 4d — 静的分析）

**定義**: anomaly_count と net_direction の 2 軸による分類

| | net_direction > 0 | net_direction ≤ 0 |
|---|---|---|
| anomaly_count > 0 | 遷移駆動 | 駆動・逆方向 |
| anomaly_count = 0 | 方向支持 | 中立 |

各カテゴリの質問数を報告する。

### L3-4: ゲート開放率

**定義**: 層 k → 層 k+1 の遷移で、R(P) 経由の到達性によりゲート条件を満たす記述素の比率。

- 各層間について: gate_opened / gate_total
- 低い場合、R(P) の波及効果が不足している

### L3-5: 層形状

**定義**: Q(P) の各層の質問数分布。

- 各層の質問数、アノマリー質問数
- 漏斗型（深層ほど狭い）が理想的

## スクリプト対応

| メトリクス | スクリプト |
|-----------|----------|
| L2-0 到達性 | check/reachability.py |
| L2-1 完全性 | check/completeness.py |
| L2-2 同化接続性 | check/assimilation_connectivity.py |
| L2-3 発掘連鎖 | check/excavation_chain.py |
| L2-4 多層構造 | check/layer_structure.py |
| L2-5 シフト方向 | check/shift_direction.py |
| L3-1 遷移方向スコア | metric/shift/transition_drive.py |
| L3-2 駆動率 | metric/shift/transition_drive.py |
| L3-3 質問4分類 | metric/shift/transition_drive.py |
| L3-4 ゲート開放率 | metric/structure/qp_report.py |
| L3-5 層形状 | metric/structure/qp_report.py |

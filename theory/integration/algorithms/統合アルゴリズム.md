# 統合アルゴリズム

## 概要

個別アルゴリズムの組み合わせと適用順を明文化した 4 フェーズ＋反復ループのアルゴリズム。

統合アルゴリズムは統合ルールのみを参照し、個別アルゴリズムへの参照は統合ルールが担う。この三層構造（統合アルゴリズム → 統合ルール → 個別アルゴリズム）により、個別アルゴリズムの差し替えが統合アルゴリズム本体に影響しない。

## 入力

- S: 問題文
- T: 真理論（正解のストーリー）
- Ps: S の記述素群
- Pt: T の記述素群

## 出力

- 記述素空間 F'
- パラダイム群（メインパス、サブパス、各パラダイムの P_pred, Conceivable(P), R(P)）
- 質問群（ans 写像、prerequisites、役割、大区分情報付き）

## 使用規則

- 空間構築
- 質問構造設計
- 質問生成
- 補完検証
- 多層構造検証
- シフト方向検証
- 不足ルーティング

## 手順

### Phase 1: 空間構築

規則「空間構築」を適用し、記述素空間とパラダイム群を構築する。

#### Step 1-1: 記述素展開

規則「空間構築」Step 1 に従い、Ps/Pt から記述素空間 F' を生成する。

#### Step 1-2: パラダイム発見

規則「空間構築」Step 2 に従い、F' からパラダイム群を見出す。メインパスとサブパスを決定する。

#### Step 1-3: 内部構造構成

規則「空間構築」Step 3 に従い、各パラダイムに P_pred, Conceivable(P), R(P) を構成する。

R(P) の構成では横辺（Rule 1〜4）を適用する。ゲート辺（Rule 5）は Phase 2 の結果を受けて追加される。

### Phase 2: 質問構造設計

規則「質問構造設計」を適用し、アノマリーからの逆算により各パラダイムの質問構造を設計する。

#### Step 2-1: アノマリー目標設定

規則「質問構造設計」Step 1 に従い、各パラダイム P_i（T を除く）のアノマリー目標を設定する。

#### Step 2-2: 認知的到達経路の逆算

規則「質問構造設計」Step 2 に従い、各アノマリー質問への認知的到達経路を逆算で設計する。

#### Step 2-3: 層構造への配置

規則「質問構造設計」Step 3 に従い、逆算結果を層に配置し、ゲート辺を設計する。ゲート辺は R(P) に追加する。

#### Step 2-4: 素材不足の検出

規則「質問構造設計」Step 4 に従い、素材不足がある場合、Phase 1 への差し戻し情報を記録する。

### Phase 3: 質問生成

規則「質問生成」を適用し、Phase 2 の構造設計をもとに具体的な質問を生成する。

#### Step 3-1: 質問候補生成

規則「質問生成」Step 1 に従い、Phase 2 の層配置を尊重して質問候補を生成する。

#### Step 3-2: 認知的前提の設定

規則「質問生成」Step 2 に従い、Phase 2 の逆算結果から各質問の prerequisites を導出する。

#### Step 3-3: 役割付与・大区分配置

規則「質問生成」Step 3 に従い、役割と大区分を設定する。

#### Step 3-4: フェーズ到達・同化接続性の検証

規則「質問生成」Step 4 に従い、フェーズ到達保証と同化接続性を検証する。

### Phase 4: 検証と反復

#### Step 4a: 補完検証（静的到達性）

規則「補完検証」Step 1 に従い、各パラダイムの anomaly 到達性を静的に検証する。

#### Step 4b: 補完検証（動的発掘連鎖）

規則「補完検証」Step 2 に従い、同化連鎖による anomaly の動的発掘をシミュレーションする。

#### Step 4c: 多層構造検証

規則「多層構造検証」を適用し、Q(P) の層構造品質を検証する。

- 層0のアノマリー比率
- アノマリーの初回到達深さ
- ボトルネックの有無
- アノマリーの層分散

#### Step 4d: シフト方向検証

規則「シフト方向検証」を適用し、パラダイムシフトの方向をシミュレーションで検証する。

- P_i フェーズの質問回答シミュレーション
- シフト時点での alignment 計算
- 想定する P_{i+1} が argmax であることの確認

#### Step 4e: 不足ルーティング

規則「不足ルーティング」を適用し、検証結果に基づき不足の種類に応じた差し戻しを行う。

| 不足の種類 | 差し戻し先 | 対処内容 |
|-----------|-----------|---------|
| 素材不足（記述素、R(P)） | Phase 1 | 記述素の追加、R(P) の修正 |
| 構造不足（経路、層配置） | Phase 2 | 認知的到達経路の再設計 |
| 質問不足（質問数、偶然の開き） | Phase 3 | 質問の追加・修正 |

差し戻し後は当該 Phase から Phase 4 まで再実行する。

## フェーズ間の依存と反復

```
Phase 1 → Phase 2 → Phase 3 → Phase 4
              ↑          ↑          |
              |          +----------+ (質問不足)
              +---------------------+ (素材不足・構造不足)
```

Phase 4 の全検証が通過すれば完了とし、形式化（JSON 変換）に進む。

## 備考

- 名称は暫定的なもの
- Phase 2（質問構造設計）が本アルゴリズムの核心的な新規要素である
- Phase 4 の反復回数に理論的な上限は設けないが、実用上は 3 回程度の反復で収束することが期待される
- 本アルゴリズムの性質については theory/terms.md「アルゴリズムの性質」を参照

# 統合アルゴリズム

## 概要

個別アルゴリズムの組み合わせと適用順を明文化した 4 フェーズ＋反復ループのアルゴリズム。

統合アルゴリズムは統合ルールのみを参照し、個別アルゴリズムへの参照は統合ルールが担う。この三層構造（統合アルゴリズム → 統合ルール → 個別アルゴリズム）により、個別アルゴリズムの差し替えが統合アルゴリズム本体に影響しない。

## 入力

- S: 問題文
- T: 真理論（正解のストーリー）
- Ps: S の記述素群
- Pt: T の記述素群

## 出力

- 記述素空間 F'
- パラダイム群（メインパス、サブパス、各パラダイムの P_pred, R(P)）
- 質問群（ans 写像、prerequisites、役割、大区分情報付き）

## 使用規則

- 空間構築
- 質問構造設計
- 質問生成
- 補完検証
- 多層構造検証
- シフト方向検証
- 不足ルーティング

## 大域目標

Phase 4 の全検証が目指す最上位の目標:

**全ての質問選択順において行き詰まりなく T に到達できること**

行き詰まりとは、T に到達する前にオープン質問が尽きる状態を指す。Phase 4 の各検証はこの目標の達成を異なる観点から支える。

## 手順

### Phase 1: 空間構築

規則「空間構築」を適用し、記述素空間とパラダイム群を構築する。

#### Step 1-1: 記述素展開

規則「空間構築」に従い、Ps/Pt から記述素空間 F' を生成する。

#### Step 1-2: パラダイム発見

規則「空間構築」に従い、F' からパラダイム群を見出す。メインパスとサブパスを決定する。

#### Step 1-3: 内部構造構成

規則「空間構築」に従い、各パラダイムに P_pred, R(P) を構成する。

R(P) の構成では横辺（Rule 1〜4）を適用する。ゲート辺（Rule 5）は Phase 2 の結果を受けて追加される。

#### Step 1-4: Explained 包含連鎖の検証

規則「空間構築」に従い、基準パス上で Explained(P_i) ⊂ Explained(P_{i+1}) が成立することを検証する。不成立の場合は Step 1-3 に戻り P_pred を修正する。

### Phase 2: 質問構造設計

規則「質問構造設計」を適用し、アノマリーからの逆算により各パラダイムの質問構造を設計する。

#### Step 2-1: アノマリー目標設定

規則「質問構造設計」に従い、各パラダイム P_i（T を除く）のアノマリー目標を設定する。

#### Step 2-2: 認知的到達経路の逆算

規則「質問構造設計」に従い、各アノマリー質問への認知的到達経路を逆算で設計する。

#### Step 2-3: 層構造への配置

規則「質問構造設計」に従い、逆算結果を層に配置し、ゲート辺を設計する。ゲート辺は R(P) に追加する。

#### Step 2-4: 素材不足の検出

規則「質問構造設計」に従い、素材不足がある場合、Phase 1 への差し戻し情報を記録する。

### Phase 3: 質問生成

規則「質問生成」を適用し、Phase 2 の構造設計をもとに具体的な質問を生成する。

#### Step 3-1: 質問候補生成

規則「質問生成」に従い、Phase 2 の層配置を尊重して質問候補を生成する。

#### Step 3-2: 認知的前提の設定

規則「質問生成」に従い、Phase 2 の逆算結果から各質問の prerequisites を導出する。

#### Step 3-3: 役割付与・大区分配置

規則「質問生成」に従い、役割と大区分を設定する。

#### Step 3-4: フェーズ到達の検証

規則「質問生成」に従い、フェーズ到達保証を検証する。

> **注記**: 同化接続性検証は適用保留中のためスキップする。

### Phase 4: 検証と反復

大域目標（行き詰まりなく T に到達）の達成を多角的に検証し、不足があれば反復する。

#### Step 4a: 完全性検証

規則「補完検証」に従い、各パラダイムのアノマリー記述素が質問群でカバーされていることを検証する（局所条件・大域条件）。

完全性は大域目標の必要条件である。全アノマリーが発掘されなければシフトに必要な tension が蓄積されない。

#### Step 4b: 同化接続性・発掘連鎖の検証

> **適用スキップ**: 推定 O に基づく近似の信憑性が未確定のため、同化接続性検証と発掘連鎖検証の適用を保留する。代替として、Step 4e（到達パス検証）が動的な行き詰まりを直接検出し、Step 4f（構造的品質診断）が構造的な原因候補を提示する。

#### Step 4c: 多層構造検証

規則「多層構造検証」を適用し、Q(P) の層構造品質を検証する。

- 層0のアノマリー比率
- ボトルネックの有無
- アノマリーの層分散

#### Step 4d: シフト方向検証

規則「シフト方向検証」を適用し、パラダイムシフトの方向を検証する。

- **静的分析**: Q(P_i) の各質問を P_pred 比較で 4 分類し、遷移方向スコア・駆動率を評価する
- **動的検証**: 特定回答順序でのシミュレーションにより、シフト時点で select_shift_target が P_{i+1} を選択することを確認する

#### Step 4e: 到達パス検証

ゲームシミュレーションにより、行き詰まり（T に到達する前にオープン質問が尽きる状態）の有無を検証する。複数の質問選択順（先頭順 + ランダム N 回）で試行する。

この検証は大域目標を直接テストする。全試行で T に到達すれば OK、1 つでも行き詰まりがあれば NG とする。NG の場合、Step 4f の診断結果を参照して原因を特定する。

#### Step 4f: 構造的品質診断

各パラダイムの Q(P) について、以下の構造的品質を定量評価する。

- **前提閉包性（L3-6）**: Q(P) 内の各質問の prerequisites がパラダイム内（Q(P) + 初期観測）で充足されるかを検証し、不足記述素を列挙する
- **層間連鎖性（L3-7）**: Q(P) の層構造において、各層遷移が R(P) の到達性で接続されているかを検証し、到達不足記述素を列挙する

L3-6/L3-7 は OK/NG 判定ではなく定量報告である。不足があっても、初期質問や他パラダイムとの関係で前提が充足される場合がある。Step 4e の結果と合わせて以下のように判断する:

| Step 4e（到達パス） | Step 4f（構造的品質） | 判断 |
|---|---|---|
| NG（行き詰まり） | 不足あり | 不足が原因候補。差し戻しで改善を試みる |
| OK（到達成功） | 不足あり | 不足は許容範囲。改善は任意 |
| NG（行き詰まり） | 不足なし | 他の原因（シフト方向、閾値設定等）を調査 |

#### Step 4g: 不足ルーティング

規則「不足ルーティング」を適用し、検証結果に基づき不足の種類に応じた差し戻しを行う。

| 不足の種類 | 差し戻し先 | 対処内容 |
|-----------|-----------|---------|
| 素材不足（記述素、R(P)） | Phase 1 | 記述素の追加、R(P) の修正 |
| 構造不足（経路、層配置） | Phase 2 | 認知的到達経路の再設計 |
| 質問不足（質問数、アノマリー導入質問） | Phase 3 | 質問の追加・修正 |

差し戻し後は当該 Phase から Phase 4 まで再実行する。

## フェーズ間の依存と反復

```
Phase 1 → Phase 2 → Phase 3 → Phase 4
              ↑          ↑          |
              |          +----------+ (質問不足)
              +---------------------+ (素材不足・構造不足)
```

Phase 4 の全検証（特に Step 4e の到達パス検証）が通過すれば完了とし、形式化（JSON 変換）に進む。

## 備考

- 名称は暫定的なもの
- Phase 2（質問構造設計）が本アルゴリズムの核心的な新規要素である
- Phase 4 の反復回数に理論的な上限は設けないが、実用上は 3 回程度の反復で収束することが期待される
- 本アルゴリズムの性質については theory/terms.md「アルゴリズムの性質」を参照

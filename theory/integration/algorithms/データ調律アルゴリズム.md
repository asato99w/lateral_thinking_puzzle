# データ調律アルゴリズム

## 概要

Phase B のアルゴリズム。統合アルゴリズム（Phase A）が生成した JSON データを、検証スクリプト（eval）の結果に基づいて直接調律し、大域目標の達成を目指す。

統合アルゴリズムとは独立した文書である。統合アルゴリズムが理論駆動でサンプルを生成するのに対し、本アルゴリズムは検証駆動で JSON データを改善する。

## 入力

- JSON データ（`app/poc/data/` 配下）
- 検証スクリプト群（`app/poc/scripts/eval/`）
- メトリクス定義（`theory/integration/evaluation/メトリクス.md`）

## 出力

- 改善された JSON データ
- 調律履歴（`samples/{puzzle}/{iteration}/history/`）

## 大域目標

統合アルゴリズムと同一: 行き詰まりなく T に到達するゲーム体験を実現する。

## 適用条件

- Phase A が完了していること（形式化 → JSON 変換 → 初回検証が実行済み）
- L2 検証に NG が存在すること

## 検証スクリプトと JSON フィールドの対応表

NG の原因を特定し、修正対象の JSON フィールドを絞り込むための対応表。

| 検証 | NG の主な原因 | 修正対象の JSON フィールド |
|------|-------------|------------------------|
| L2-0 (O*シフト連鎖) | シフト条件の設計不備 | `p_pred`, `shift_threshold` |
| L2-1 (完全性) | アノマリーカバー不足・質問効果の不備 | `paradigms` (Q(P)), `ans_yes`/`ans_no` (effect) |
| L2-4 (多層構造) | 質問の前提条件・層配置の不備 | `prerequisites`, `paradigms` |
| L2-5 (到達パス) | 総合的な構造問題 | L3-6/L3-7 の診断結果を参照し、総合的に修正 |

**補足**: L2-2（同化接続性）と L2-3（発掘連鎖）は現在適用保留のため、本アルゴリズムの対象外。

## 手順

### Step 1: 全検証の実行

`app/poc/scripts/eval/` 配下の全スクリプトを実行し、結果をサマリとして整理する。

- `check/` 配下: L2 検証（OK/NG 判定）
- `metric/` 配下: L3 品質メトリクス（定量報告）

実行はすべて `app/poc/scripts/` をカレントディレクトリとして行う。

### Step 2: 診断

NG の検証結果を分析し、根本原因を特定する。

**優先順位**: L2-0 > L2-1 > L2-4 > L2-5

優先順位の根拠:
- L2-0（シフト連鎖）が NG の場合、パラダイム遷移の基盤が成立していないため、他の検証結果は意味をなさない
- L2-1（完全性）は質問設計の網羅性に関わり、L2-4・L2-5 の前提となる
- L2-4（多層構造）は層配置の問題であり、L2-5 の到達パスに影響する
- L2-5（到達パス）は最終的な動的検証であり、他の NG が解消されてから対処する

**L2-5 の診断手順**: L2-5 が NG の場合、まず L3-6（前提閉包性）と L3-7（層間連鎖性）の結果を確認する。これらの品質メトリクスが不足記述素を具体的に列挙するため、修正箇所の特定に有用である。

**アルゴリズム不備の検討**: 診断の結果、NG の原因が対応表の修正分類（フィールド値の調整・所属変更等）では対処できない構造的問題である場合、本アルゴリズムの適用範囲外と判断する。この場合は NG の内容・対処できない理由・不足している手順を履歴に記録し、ユーザーに報告して終了する。

### Step 3: 修正計画

診断結果に基づき、修正計画を策定する。修正は以下の 4 分類に整理する。

| 分類 | 内容 | 影響範囲 |
|------|------|---------|
| パラダイム構造 | `p_pred`, `shift_threshold`, パラダイム定義 | L2-0 に直結 |
| 質問効果 | `ans_yes`, `ans_no` の effect 記述素 | L2-1 に直結 |
| 所属・前提 | `prerequisites`, 質問のパラダイム所属 | L2-4 に直結 |
| 初期設定 | `init_paradigm`, 初期観測 | 全検証に影響 |

### Step 4: 修正実行

修正計画に基づき、JSON データを直接編集する。

- 1 回の修正ラウンドでは、診断で特定した最優先の NG に集中する
- 複数の NG を同時に修正する場合は、相互影響を考慮する

### Step 5: 再検証

修正後に全検証スクリプトを再実行する。

- **対象検証**: 修正が直接影響する L2 検証
- **回帰チェック**: 修正前に OK だった L2 検証が NG に変わっていないこと

回帰が発生した場合は、修正を見直す。

### Step 6: 記録

ラウンドの結果を `samples/{puzzle}/{iteration}/history/` に追記する（履歴記録の形式を参照）。修正前の検証結果・診断・修正内容・修正後の検証結果を記録する。履歴がトレーサビリティを担う。

### Step 7: 継続判定

- **全 L2 OK** → 終了。L3 の改善は任意（ユーザー判断）
- **NG 残存** → Step 2 に戻る

## 収束条件

全 L2 検証が OK であること。L3 品質メトリクスの改善は任意目標であり、収束条件には含めない。

## 履歴記録の形式

各ラウンドの記録は以下のテンプレートに従う。

```markdown
# 調律ラウンド NNNN — YYYY-MM-DD

## 検証結果（修正前）

| 検証 | 結果 |
|------|------|
| L2-0 | OK/NG |
| L2-1 | OK/NG |
| L2-4 | OK/NG |
| L2-5 | OK/NG |

## 診断

[NG の原因分析]

## 修正内容

[修正した JSON フィールドと変更内容]

## 検証結果（修正後）

| 検証 | 結果 | 変化 |
|------|------|------|
| L2-0 | OK/NG | 改善/維持/回帰 |
| L2-1 | OK/NG | 改善/維持/回帰 |
| L2-4 | OK/NG | 改善/維持/回帰 |
| L2-5 | OK/NG | 改善/維持/回帰 |
```

## 備考

- エンジン（`app/poc/src/`）と検証スクリプト（`app/poc/scripts/eval/`）は基本的に正しい前提で運用する。検証が NG の場合、まずデータ側の原因を疑う。ただし、スクリプトやエンジンに矛盾・不備が見つかった場合は、その内容を報告して停止する
- 理論（`theory/`）は変更しない。理論の問題が疑われる場合はユーザーに報告して停止する

# 質問分類アルゴリズム Q3: ユーザー向け質問分類

## 概要

Q1 または Q2 の出力（質問群）を入力とし、プレイヤー向けのトピック分類を付与するアルゴリズム。質問の機能的役割（探索/蓄積/駆動/分岐）や大区分（I/II/III）とは独立した、ユーザーインターフェース上の分類である。

プレイヤーが自分の思いついた質問を効率的に探せるようにすることを目的とする。

## 入力

- 質問群（Q1 または Q2 の出力）
- パラダイム群（情報漏洩検証に使用）
- 初期オープン質問集合（init_questions の出力）

## 出力

- 質問群にトピックカテゴリが付与されたもの
- （必要に応じて）初期オープン構成への調整フィードバック

## 定義

- **トピックカテゴリ**: 質問テキストの表層的な意味内容に基づく分類単位。パラダイムや記述素の内部構造とは独立に定義する。プレイヤーが「この種の質問はどこにあるか」と考えたときに自然に対応する区分。
- **情報漏洩**: カテゴリの構造（名称、サイズ、出現タイミング）からパズルの内部構造（パラダイム遷移、核心的事実）が推測可能になること。
- **カテゴリバランス**: 各カテゴリの質問数が極端に偏っていない状態。

## 手順

### Step 1: 初期オープン質問からのトピックカテゴリ定義

初期オープン質問集合のテキストに基づき、プレイヤーが自然に思い浮かべるトピック領域を列挙する。

1. **初期オープン質問のみ**のテキストを概観し、繰り返し現れる主題やキーワードを抽出する
2. 抽出した主題を、プレイヤーが直感的に理解できるカテゴリとしてまとめる
   - 例: 場所、人物の行動、料理・食べ物、感情・心理、時間・状況 等
   - カテゴリ名はパズルの一般的な表層内容を反映するものとし、特定のパズル構造を示唆するものは避ける
3. カテゴリは内部構造（パラダイム、Ps/Pt 起源、記述素の所属）から導出しない
4. 初期オープン質問のみから定義することで、カテゴリ名・構造が初期パラダイム（P1）のスコープ外の情報を含まないことを構造的に保証する

### Step 2: 初期オープン質問の割り当てとバランス検証

初期オープン質問を定義したカテゴリに割り当て、カテゴリ体系の妥当性を検証する。

1. 各初期オープン質問を1つのトピックカテゴリに割り当てる
   - 質問テキストが最も強く関連するカテゴリを選択する
   - 複数カテゴリにまたがる場合は、質問テキストの最も主要なトピックに基づいて割り当てる
2. 各カテゴリの質問数を集計し、極端な偏りがないことを確認する
   - 比率が著しく大きい場合（目安: 最大/最小 > 3）、カテゴリの分割・統合で対処し、再割り当てする
3. どのカテゴリにも自然に属さない質問がある場合、Step 1 に戻りカテゴリの調整を検討する

### Step 3: 残り質問の既存カテゴリへの割り当て

初期オープン質問集合に含まれない残りの質問を、Step 1 で定義したカテゴリに割り当てる。

1. 各質問のテキストに基づき、最も適合する既存カテゴリに割り当てる
2. **新規カテゴリは追加しない**。後発質問の割り当てのためにカテゴリを追加すると、そのカテゴリ名が初期パラダイム外の情報を反映し、情報漏洩となる
3. どのカテゴリにも自然に収まらない質問がある場合、以下の順で対処する:
   a. 最も近いカテゴリに割り当てる（多少の不自然さは許容する）
   b. Step 1 のカテゴリ名をより一般的な表現に拡張し、収容力を高める（ただし初期オープン質問との整合性を維持する）

### Step 4: 全体バランス検証

全質問の割り当て完了後、カテゴリ全体のバランスを検証する。

1. 各カテゴリの全質問数（初期オープン + 後発）を集計する
2. 極端な偏りがある場合（目安: 最大/最小 > 3）、以下で対処する:
   - 過大カテゴリの分割を検討する。ただし分割後のカテゴリ名が初期オープン質問の内容から自然に導出できる場合に限る
   - 過小カテゴリの統合を検討する
3. 対処後、Step 2・Step 3 に戻って再割り当てする

### Step 5: 情報漏洩検証

カテゴリ割り当ての結果が情報漏洩を生じていないことを検証する。

Step 1 で初期オープン質問のみからカテゴリを定義したことにより、カテゴリ名による漏洩は構造的に防止されている。ここでは残りの漏洩リスクを検証する。

1. 各カテゴリについて、含まれる質問の effect 記述素がどのパラダイムに属するかを集計する
2. 以下の条件を確認する:
   - あるカテゴリが特定パラダイムでのみ予測が確定する記述素に過度に集中していないか（カテゴリ内の質問がオープンする順序から、パラダイム遷移の方向が推測可能にならないか）
   - カテゴリ間の質問数の差異が、ゲーム進行に伴って大きく変動し、パラダイム構造を示唆しないか
3. 違反がある場合、Step 1 に戻りカテゴリの再定義（名称の一般化、統合）で対処する

### Step 6: 最終検証

分類結果がゲーム全体を通じて安定していることを確認する。

1. カテゴリは初期オープン質問から定義されているため、ゲーム開始時点から全カテゴリが表示される（カテゴリの出現問題は構造的に解決済み）
2. ゲーム進行に伴い、各カテゴリに後発質問が追加されていく。カテゴリがゲーム中に消滅しないことを確認する（初期オープン質問が各カテゴリに存在するため、これも構造的に保証される）
3. 後発質問の既存カテゴリへの割り当てが、プレイヤーの直感に反しないことを全体的に確認する

## 備考

- Q3 は Q1/Q2 の出力に対する後処理として位置づけられる。Q1/Q2 の質問の内容や構造を変更しない
- トピックカテゴリは質問の機能的役割（探索/蓄積/駆動/分岐）や大区分（I/II/III）とは独立の分類軸である。一つの質問は役割・大区分・トピックカテゴリの3つの分類を同時に持つ
- カテゴリ体系はパズルごとに異なる。一般的なカテゴリのリストを事前に固定するのではなく、各パズルの初期オープン質問の内容に応じて Step 1 で設計する
- カテゴリの安定性（出現・消滅しない）は、初期オープン質問からカテゴリを定義するアプローチにより構造的に保証される。旧版で必要だった初期オープン分布検証（旧 Step 5）は不要となった
- 本アルゴリズムの性質については theory/terms.md「アルゴリズムの性質」を参照

# 質問構造設計

## 概要

アノマリーからの逆算により、各パラダイムの質問構造（多層の認知的到達経路）を設計するアルゴリズム。Q1/Q2 が質問を前方向に生成するのに対し、本アルゴリズムは目的地（アノマリー質問）から逆方向に到達経路を設計する。

Phase 2 に位置し、Phase 1（空間構築）の出力を受けて Phase 3（質問生成）の入力となる構造設計を生成する。

## 入力

- 記述素空間 F'（記述素展開の出力）
- パラダイム群（パラダイム発見の出力。各パラダイムの P_pred, R(P) を含む）

## 出力

- 各パラダイムのアノマリー目標（アノマリー質問の目標リスト）
- 認知的到達経路（アノマリー質問への逆算された認知ステップの連鎖）
- 層配置（質問の層割り当て、ゲート辺の仕様）
- 素材不足レポート（不足する中間記述素・ゲート辺のリスト）

## 使用規則

- 偶然の開き
- 関係構造の構成 Rule 5（ゲート辺）

## 手順

### Step 1: アノマリー目標設定

各パラダイム P_i（T を除く）のアノマリー目標を設定する。

1. P_pred(P_i) 内で P_pred(d) ≠ T(d) となる記述素を列挙する
2. これらの記述素を effect に含む質問候補をアノマリー質問の候補とする
3. 規則「偶然の開き」を参照し、開放記述素と異常記述素を組み合わせた偶然の開き構造が成立する候補を特定する
4. 各 P_i に対するアノマリー質問の目標数を設定する（近傍パラダイムへのシフト候補条件 resolve >= N を充足するために必要な数）

### Step 2: 認知的到達経路の逆算

各アノマリー質問への認知的到達経路を逆算で設計する。

1. アノマリー質問を起点とし、「プレイヤーがこの質問を思いつくには何を事前に知っている必要があるか」を逆方向に展開する
2. 各ステップは認知的条件（「d を知ることで初めて次の問いが発想される」）として定義する。論理的成立条件ではなく、認知的な到達条件である
3. 展開を繰り返し、前提なしで問える層0の質問に到達するまで逆算する
4. 逆算の各中間ステップについて、対応する記述素が P_pred(P_i) 内に存在することを確認する

逆算は DAG（有向非巡回グラフ）構造となり、一つのアノマリー質問に複数の到達経路が存在しうる。

### Step 3: 層構造への配置

逆算された経路をもとに質問を層に配置する。

1. 逆算の深さに基づいて各質問の層を決定する
   - 層 0: 前提なしの質問群（初期オープン）
   - 層 k: 層 k-1 の質問の回答で開く質問群
   - 深層: アノマリー質問
2. 規則「関係構造の構成 Rule 5」を適用し、層間の遷移に必要なゲート辺を設計する
   - 浅い層の記述素 d_src から深い層の記述素 d_tgt への関係 (d_src, d_tgt, w) を定める
   - ゲート辺は原則として強い関係（w > 0.6）とし、同化 1 ホップで次層の質問がオープンする
3. 各層内の横の広がり（並列な質問群）を確認する
   - 層内の複数の質問が独立して探索可能であること
   - アノマリーへの到達が単一の質問経路に依存しないこと（ボトルネック回避）

### Step 4: 素材不足の検出

逆算結果に対して、現在の記述素空間と R(P) の不足を検出する。

1. **中間記述素の不足**: Step 2 の逆算で必要とされる中間ステップの記述素が F' に存在しない場合を検出する。Phase 1 への差し戻し情報（追加すべき記述素の仕様）として記録する
2. **ゲート辺の不足**: Step 3 で設計されたゲート辺のうち、既存の R(P) に存在しないものを検出する。Phase 1 の R(P) への追加情報として記録する
3. **経路の疎な領域**: アノマリーへの到達経路が単一（冗長性なし）の箇所を特定する。Phase 1 での記述素追加または Phase 3 での質問追加により解消する候補として記録する

素材不足レポートは統合アルゴリズムの Phase 4e（不足ルーティング）で参照される。

## 備考

- 本アルゴリズムは Q1/Q2 の前段階として質問構造を設計する。Q1/Q2 は本アルゴリズムの出力（層配置、認知的到達経路）を尊重して質問を生成する
- prerequisites は本アルゴリズムの逆算結果から導出される。Q1 Step 6 の「前提事実の割り当て」は本アルゴリズムの出力を入力とする
- 名称は暫定的なもの
- 本アルゴリズムの性質については theory/terms.md「アルゴリズムの性質」を参照

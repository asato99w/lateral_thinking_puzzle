# パラダイムシフトの機構

## 概要

パラダイムシフトは、現在のパラダイムが観測を説明しきれなくなったときに発生する。シフトの発動と遷移先の選択は統合されており、以下の3条件を全て満たす候補が1つ以上存在する場合にシフトが起こる。

1. **近傍**: 候補が現パラダイムの近傍であること（跳躍の防止）
2. **tension strict `<`**: 候補の tension が現パラダイムより厳密に小さいこと（ループの防止）
3. **resolve >= N**: 候補の resolve 閾値を満たすこと（十分な証拠の確保）

## 緊張関数 tension(O, P)

現在のパラダイム P に対するアノマリーの蓄積度を測る。

### 定義

**tension(O, P) = |{d ∈ O | P_pred(P, d) ∈ {0, 1} かつ P_pred(P, d) ≠ O(d)}|**

O の観測のうち、P が確定的な予測を持ち、かつ予測と矛盾するもの（アノマリー）の数。

### 性質

- O は単調に拡大し、一度 O に入った記述素は除かれない。アノマリーの寄与は非負であるため、tension は**単調非減少**である。
- O と P のみから計算され、H に依存しない（客観的な判定）。
- P_pred(P, d) = 不定 の記述素は tension に寄与しない。これにより、パラダイムが予測を持たない観測が緊張を生むことはない。

## アノマリー集合

パラダイム P の O に対するアノマリー集合を以下で定義する。

**Anomaly(O, P) = {d ∈ O | P_pred(P, d) ∈ {0, 1} かつ P_pred(P, d) ≠ O(d)}**

tension(O, P) = |Anomaly(O, P)| である。

## resolve と attention

シフト先候補の評価に用いる二つの指標。

### resolve

**resolve(O, P_current, P_target) = |{d ∈ Anomaly(O, P_current) | P_pred(P_target, d) ∈ {0, 1} かつ P_pred(P_target, d) = O(d)}|**

P_current のアノマリーのうち、P_target が正しく予測するものの数。P_target が P_current の矛盾をどれだけ「解決」できるかを表す。

### attention

**attention(O, P_current, P_target) = |{d ∈ Anomaly(O, P_current) | P_pred(P_target, d) ∈ {0, 1}}|**

P_current のアノマリーのうち、P_target の予測範囲に含まれるものの数。P_target が P_current の問題領域にどれだけ「関与」しているかを表す。

## 近傍

パラダイム間の構造的な近接関係。跳躍（中間パラダイムを飛ばした遷移）を防止する。

### 定義

完全確定 O* のもとで、P_current のアノマリー集合への射影により近傍を定義する。

**Remaining(P', P_current) = Anomaly(O*, P_current) ∩ Anomaly(O*, P')**

P' が P_current のアノマリーをどれだけ共有しているか。Remaining が小さいほど、P' は P_current の問題をより多く解決している。

Remaining 集合の包含関係で Hasse 図を構築し、**直接の後続**（中間パラダイムが存在しない）を近傍とする。

### 性質

- O* から静的に計算される。質問の経路に依存しない。
- 中間パラダイムが存在する場合は近傍にならないため、段階的な遷移が保証される。
- ループ防止は tension strict `<` が担当するため、近傍自体にループ耐性は不要。

詳細は「近傍」規則を参照。

## 閾値 N

遷移に必要な resolve の閾値。「P_target という説明に至るために必要な証拠の量」を表す。

### 手動設定値 shift_threshold

各パラダイムに手動で設定する閾値。パズルデータ（JSON）で指定する。パズルのペーシングを制御するための設計パラメータ。

### 上限 resolve_cap

各遷移ペア (P_source, P_target) について、理想観測のもとでの resolve がペアごとの上限となる。

**resolve_cap(P_source, P_target) = resolve(O*, P_source, P_target)**

shift_threshold がこの上限を超えても、実効閾値は上限に抑えられる。

### 実効閾値

シフト判定時の実効閾値は以下で決定する:

- shift_threshold と resolve_cap の両方がある場合: **min(shift_threshold, resolve_cap)**
- shift_threshold のみ: shift_threshold
- resolve_cap のみ（shift_threshold 未設定）: resolve_cap（フォールバック）
- どちらもなし: 閾値なし（条件3 スキップ）

### 性質

- T（真理論を含むパラダイム）は Anomaly(O*, T) = {} であり、どの遷移元からも resolve = 0 で到達可能。
- shift_threshold は設計者がペーシングを制御するための値であり、resolve_cap はゲームの構造的上限である。

## シフト先選択

### 候補条件

パラダイム P' が以下の3条件を全て満たすとき、シフト候補となる。

1. **近傍**: P' ∈ neighbors(P_current)
2. **tension strict `<`**: tension(O, P') < tension(O, P_current)
3. **resolve >= N**: resolve(O, P_current, P') >= 実効閾値（実効閾値が定義されている場合）

### 選択

候補が複数存在する場合、以下の優先順位で選択する。

1. **resolve 降順**: P_current のアノマリーをより多く解決する候補を優先
2. **attention 降順**: P_current のアノマリーにより広く関与する候補を優先
3. **pid 昇順**: 同点時の決定論的なタイブレーク

候補が1つ以上あればシフト発動。候補が空ならば P_current を維持して継続する。

## シフト手続き

1. 質問への回答により O を更新する
2. 同化（現在のパラダイムの関係構造に基づく H の伝播）
3. 上記3条件を全て満たす候補を探索し、存在すればシフト
4. シフト後、新パラダイムの関係構造で H を再構成する

### 発動と選択の統合

旧モデルでは「いつシフトするか」（threshold）と「どこにシフトするか」（select_shift_target）が分離していた。新モデルでは、候補の条件自体が発動を含む。候補が存在すること自体がシフト発動の条件であり、別途の閾値判定は不要。

## 整合性関数 alignment(H, P)

候補パラダイム P が暫定理論 H とどれだけ整合するかを測る。

### 定義

**alignment(H, P) = (Σ_{d: P_pred(P,d)=1} H(d) + Σ_{d: P_pred(P,d)=0} (1 - H(d))) / |判定域(P)|**

P_pred(P, d)=1 の記述素は H(d) が 1 に近いほど、P_pred(P, d)=0 の記述素は H(d) が 0 に近いほど、alignment が高くなる。判定域の記述素を対象とする。

### 位置づけ

alignment はシフト先選択には使用しない。H の状態を観測する診断指標として定義する。同化により H は現パラダイムの予測方向に押されるため、構造的に近いパラダイムが高スコアになる傾向がある。

## 説明力関数 explained_o(O, P)

パラダイム P が観測 O をどれだけ正しく説明するかを測る。

### 定義

**explained_o(O, P) = |{d ∈ O | P_pred(P, d) ∈ {0, 1} かつ P_pred(P, d) = O(d)}|**

判定域の記述素を対象とし、O の記述素のうち P_pred が正しく予測するものの数。

### 位置づけ

explained_o はシフト先選択には使用しない。パラダイムの説明力を観測する診断指標として定義する。depth の導出（Explained 集合の包含関係）に用いる。

## データの健全性条件

### 完全確定におけるアノマリーの単調減少

メインパスのパラダイム列 P₁ → P₂ → ... → T に対して、完全確定のもとでのアノマリー数が単調に減少すること。

**|Anomaly(O*, P₁)| > |Anomaly(O*, P₂)| > ... > |Anomaly(O*, T)| = 0**

- P₁ はアノマリーが最も多い → 最初にシフトが発生する
- T はアノマリーがゼロ → P(O | T) = 1 が構造的に保証される
- 各パラダイムは前のパラダイムより少ないアノマリーを持つ → シフトのたびに安定性が増す

この条件はデータ設計時に検証すべき構造的要件である。

### 正解予測の包含（eo 単調性の構造的保証）

メインパスの連続するパラダイム P_i, P_{i+1} について、O* 上で P_i が正しく予測する記述素の集合が P_{i+1} の部分集合であること。

**{ d ∈ O* | P_pred(P_i, d) ∈ {0, 1} かつ P_pred(P_i, d) = O*(d) } ⊆ { d ∈ O* | P_pred(P_{i+1}, d) ∈ {0, 1} かつ P_pred(P_{i+1}, d) = O*(d) }**

この包含関係は、近傍の Remaining 集合の包含と整合する。Anomaly が減少し Explained が拡大する方向が、メインパスの進行方向である。

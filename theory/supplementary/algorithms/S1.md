# S1

## 概要

opening_reach の構造的不足検出結果を入力とし、各パラダイムの anomaly 到達性を充足させる追加記述素・関係・質問を生成する独立アルゴリズム。

E1/E2 による記述素空間展開と内部構造構成の後に実行され、構造的欠陥を補填する。将来的な反復型統合アルゴリズムの構成要素として設計されている。

## 入力

- opening_reach の分析結果（各パラダイムの判定結果）
  - 固有記述素 E(P_i) とその個数
  - R(P_i) による到達可能記述素
  - anomaly 生成質問と anomaly 上界
  - threshold との比較結果（OK/NG）
  - 診断情報（到達不能な共有記述素、固有→非固有の関係数）
- anomaly_discovery の分析結果（動的発掘シミュレーション）
  - 発掘可能 / 発掘不可の anomaly 質問
  - 発掘チェーン（各ステップの回答→H変化→新規オープン）
- 現在の記述素空間 F'
- パラダイム群（P_pred, R(P)）
- 質問群

## 使用規則

- anomaly 到達性充足
- 発掘連鎖到達性（新規）
- 前提事実
- 架け橋合成（E2 と共有）
- 部分的理解生成（E2 と共有）
- 関係構造の構成 Rule 3, Rule 4（参照）

## 手順

### Step 1: 不足類型の診断

各 NG パラダイム P_i について不足類型を判定する。

**静的分析（opening_reach）による類型:**

- **類型 A（固有記述素の欠如）**: |E(P_i)| == 0
- **類型 B（R(P) 接続性の欠如）**: |E(P_i)| > 0 かつ 固有→共有の関係数 == 0
- **類型 C（anomaly 上界の不足）**: 上記いずれでもなく anomaly 上界 < threshold

類型 A は B を、B は C を含意するため、A → B → C の順に対処する。

**動的分析（anomaly_discovery）による類型:**

- **類型 D（発掘連鎖の断絶）**: 静的には到達可能（opening_reach OK）だが、ゲーム進行の順序制約により実際には発掘されない

類型 D は Step 5b で検出される。類型 A〜C の解消後に残る問題として対処する。

### Step 2: 固有記述素の生成（類型 A 対応）

規則「部分的理解生成」を P_i に特化して適用する。

1. P_i の説明の中で、隣接パラダイムには含意できない独自の解釈・視点を特定する
2. 当該解釈に固有な記述素を生成する
3. 生成条件: ∀ j ≠ i, d ∉ keys(P_pred(P_j)) を満たすこと（固有性の保証）
4. 生成数: Step 4 での anomaly 生成に十分な数（類型 C の解消に必要な到達可能性を逆算）

### Step 3: R(P) の接続強化（類型 B 対応）

関係構造の構成 Rule 3, Rule 4 を定量的に適用する。

1. Step 2 で生成した固有記述素（または既存の固有記述素）を起点とする
2. 共有記述素のうち、anomaly 生成に寄与するものをターゲットとして選定する
   - P_i の P_pred と真値が異なる記述素を effect に含む質問に関連する共有記述素を優先
3. 固有→ターゲット共有記述素の関係を R(P_i) に追加する
4. w は Rule 4 の強い関係（w > 0.6）を基本とする（1ホップの同化で EPSILON 圏内に到達する必要があるため）

### Step 4: 質問の補強（類型 C 対応）

1. opening_reach の到達可能記述素を effect に含み、かつ P_i の P_pred と真値が異なる記述素も effect に含む質問を設計する
   - 前者は「開口記述素」: 同化連鎖で H が正解方向に動き質問が開く
   - 後者は「anomaly 記述素」: P_i の予測を裏切る
2. anomaly 上界が threshold 以上になるまで質問を追加する

### Step 5: 再検証

#### Step 5a: 静的到達性の検証

opening_reach を再実行し、規則「anomaly 到達性充足」を検証する。NG のパラダイムがあれば Step 1 に戻る。

#### Step 5b: 動的発掘連鎖の検証

anomaly_discovery を実行し、規則「発掘連鎖到達性」を検証する。

発掘不可の anomaly 質問がある場合（類型 D）、以下を分析する:

1. 当該質問の effect の各 (d, v) について、H[d] が v に近づくための同化経路が存在するか
2. 経路が存在しない場合、どの記述素間の関係が不足しているか
3. 経路が存在するが発火しない場合、先行する質問の発掘順序に問題がないか
4. 当該質問の prerequisites の各記述素 d について、d が O に入るための経路が確保されているか
   - d を effect に含む質問がオープンするか（H 値の到達性）
   - その質問自体が prerequisites を持つ場合、その連鎖が到達可能か

分析項目 4 は前提事実の割り当て（Q1 Step 6）後に発生しうる問題を対象とする。prerequisites の追加は質問のオープン条件を厳しくするため、既に確保された発掘連鎖を壊す可能性がある。

対処はデータ側で行う:
- 効果の開放記述素の見直し（偶然の開きの構造が成立するよう調整）
- 前提事実の設定（prerequisites により、先行質問の確定を要求して発掘順序を制御）
- 中間質問の追加（safe → 中間 → anomaly の連鎖を構成）
- 空間設計の見直し（架け橋合成による中間記述素の追加）
- prerequisite 記述素の O 到達経路の確保（R(P) への関係追加により、prerequisite 記述素を確定させる質問がオープンする同化経路を構成する）

分析項目 4 に対しては、prerequisite 記述素の O 到達経路の確保を第一選択とする。prerequisites は質問テキストから導出される意味的制約であり、到達不能を理由に prerequisites を緩めることは質問テキストとの整合性を壊すため行ってはならない。構造的対処が不可能な場合は、質問テキスト自体の修正（Q1 Step 2 への差し戻し）または質問の削除を検討する。

Step 5b で NG があれば対処後に Step 5a に戻る（静的到達性を壊していないことを確認）。

## 出力

- 追加された記述素（F' への追加分）
- 追加・変更された R(P) 関係
- 追加された質問

## Q2 との関係

S1 と Q2 は相補的に機能する。

- **S1 の担当**: 記述素空間と R(P) の構造的充足（anomaly 到達性の確保）
- **Q2 の担当**: 質問設計の検証（フェーズ到達保証、同化接続性検証）

S1 の Step 4（質問の補強）は Q2 の Step 8（同化接続性検証）の不足対処と重なる。統合アルゴリズムでは、S1 が構造的充足を先に確保し、Q2 が質問レベルの整合性を検証する順序が自然である。

opening_reach の分析結果は Q2 にも直接活用できる:

- 到達可能記述素 → Q2 Step 8 の同化起点からの到達可能ターゲットに対応
- anomaly 上界の診断 → Q2 Step 8.4「不足がある場合」の入力に対応
- 到達不能な共有記述素リスト → Q2 が優先的に質問を生成すべき記述素に対応

## 備考

- S1 は E1/E2 の出力を変更しない（追加のみ）
- opening_reach および anomaly_discovery スクリプトの分析結果を活用するアルゴリズムであり、eval スクリプトと理論的アルゴリズムの橋渡しとなる
- Step 5a（静的）と Step 5b（動的）の二段階検証により、構造的充足と実行時充足の両方を保証する
- 将来的な統合アルゴリズムでは S1 → Q1 Step 6（前提事実の割り当て）→ S1 Step 5b（再検証）→ Q2 → opening_reach / anomaly_discovery → ... の反復ループの構成要素として位置づけられる。前提事実の割り当ては質問のオープン条件を変更するため、割り当て後の再検証が必須である

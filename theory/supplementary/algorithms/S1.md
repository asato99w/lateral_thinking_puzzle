# S1: 構造的充足検証・補完アルゴリズム

## 概要

質問群と R(P) の構造がパラダイムシフトを支えるために十分かを検証し、不足を補完するアルゴリズム。

Q1 が質問を生成した後に実行され、アノマリー導入・同化接続性・発掘連鎖の3つの観点から構造的欠陥を検出・補填する。統合アルゴリズムの反復ループの構成要素として設計されている。

## 入力

- 記述素空間 F'
- パラダイム群（P_pred, R(P)）
- 質問群（Q1 の出力）
- メインパスの遷移順序

## 出力

- 追加・変更された R(P) 関係
- 追加された質問
- 検証結果（各遷移の OK/NG）

## 使用規則

- 同化接続性検証
- 前提事実
- 関係構造の構成 Rule 3, Rule 4, Rule 5

## 手順

### Step 1: アノマリー導入質問の検証

各パラダイム P_i（T を除く）について、アノマリーを導入できる質問が十分に存在するかを検証する。

Q1 Step 3 で設計されたアノマリー導入質問について:

1. 各 P_i に対して、effect が以下の両方を含む質問を列挙する:
   - P_pred(P_i, d) と真値が一致する記述素（同化で H が正解方向に動き、質問がオープンする理由となる）
   - P_pred(P_i, d) と真値が食い違う記述素（回答により O に入り、アノマリーとなる）
2. 列挙された質問がシフトに必要な数のアノマリーを蓄積できることを確認する
3. **完全性の検証**: 全アノマリー記述素（Anomaly(O*, P_i) = {d ∈ P_pred(P_i) : P_pred(P_i, d) ≠ T(d)}）がいずれかの質問の effect でカバーされるかを確認する。カバーされないアノマリー記述素が存在する場合、NG とする

NG の場合: Q1 Step 3 への差し戻し（アノマリー導入質問の追加設計）

### Step 2: 同化接続性の検証

各遷移 P_i → P_{i+1} について、シフト後の同化メカニズムが新たな質問を開くことができる接続性が R(P_{i+1}) に存在するかを検証する。

規則「同化接続性検証」を適用する:

1. P_i フェーズ終了時の推定観測 O_i を計算する
2. Consistent(O_i, P_{i+1}) と Anomaly(O_i, P_{i+1}) を計算する
3. R(P_{i+1}) で Consistent と Anomaly の両方から到達可能なターゲット記述素 T_reach を計算する
4. T_reach の各ターゲット記述素 t について、以下を確認する:
   - t を effect に含む未回答質問 q が存在すること
   - 3a 経路（Consistent からの到達）の場合: effect(q)[t] の値が P_pred(P_{i+1}, t) と一致すること
   - 3b 経路（Anomaly からの到達）の場合: P_pred 一致は不要（到達可能であれば十分）

NG の場合:
- R(P_{i+1}) にターゲット記述素への関係を追加する（関係構造の構成 Rule 3, Rule 4）
- または T_reach の記述素を effect に含む質問を追加する

### Step 3: 動的発掘連鎖の検証

ゲーム進行をシミュレーションし、質問の開放が順序的に成立するかを検証する。

1. データで指定された初期オープン質問から開始する（データに init_question_ids がなければ Q(P_init) の safe 質問で代替）
2. 各回答による O の更新 → R(P) 到達性による新規質問のオープンを追跡する
3. 各パラダイムフェーズで、アノマリー導入質問が実際にオープンされることを確認する
4. **横方向探索の検証**: 初期オープンからの同化連鎖により質問オープンが横方向に広がることを確認する。各パラダイムフェーズで、オープンされた質問の順序と、同化による新規オープンの連鎖を追跡し、探索空間が適切に拡大しているかを検証する

NG の場合（発掘連鎖の断絶）、以下を分析する:

1. 当該質問の effect の各 (d, v) について、Consistent(O, P) または Anomaly(O, P) から R(P) 経由の到達経路が存在するか
2. 経路が存在しない場合、どの記述素間の関係が不足しているか
3. 経路が存在するが到達しない場合、先行する質問の発掘順序に問題がないか
4. 当該質問の prerequisites の各記述素 d について、d が O に入るための経路が確保されているか

対処:
- 到達経路の不足 → R(P) への関係追加
- 発掘順序の問題 → prerequisites の調整、中間質問の追加
- prerequisites の到達性問題 → prerequisite 記述素を確定させる質問がオープンする同化経路の構成（R(P) への関係追加）

prerequisites は質問テキストから導出される意味的制約であり、到達不能を理由に prerequisites を緩めることは質問テキストとの整合性を壊す。構造的対処が不可能な場合は、質問テキスト自体の修正（Q1 への差し戻し）または質問の削除を検討する。

### Step 4: 再検証

Step 2〜3 の対処が他の検証を壊していないことを確認する。

- Step 2 の対処後 → Step 3 を再実行
- Step 3 の対処後 → Step 2 を再実行（同化接続性を壊していないことの確認）

NG があれば Step 1 に戻る。

## Q1 Step 6 との関係

Q1 Step 6（前提事実の割り当て）は質問のオープン条件を厳しくするため、S1 が確保した発掘連鎖を壊す可能性がある。統合アルゴリズムの反復ループにおいて、Q1 Step 6 の適用後は S1 Step 3 を再実行し、prerequisites の追加により発掘不可能になった質問がないことを検証する。

## 備考

- S1 は記述素空間 F' を変更しない（R(P) と質問群を追加・変更する）
- Step 2（静的）と Step 3（動的）の二段階検証により、構造的充足と実行時充足の両方を保証する
- 名称は暫定的なもの
- 本アルゴリズムの性質については theory/terms.md「アルゴリズムの性質」を参照

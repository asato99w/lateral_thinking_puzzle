# 補充検証：S1 適用

入力:
- 形式化（形式化.md）に基づく JSON データ（app/poc/data/bar_man.json）
- anomaly_discovery.py の検証結果

## 検証結果

### 静的検証（opening_reach）

既存の検証で OK。

### 動的検証（anomaly_discovery）

#### Part 1: 初期オープン汚染チェック

init_questions のロジック修正（anomaly effect を含む質問を除外）により **OK**。

#### Part 2: 発掘連鎖シミュレーション

47 件中 31 件が発掘可能。**16 件が発掘不可**。

加えて 3 件の追加不足（q03, q51, q52）が修正後の再検証で判明。合計 **19 件**を修正。

## 不足診断

### 共通原因

19 件すべてが類型 D（発掘連鎖の断絶）。静的には到達可能だが、ゲーム進行の順序制約により実際には発掘されない。

**根本原因**: 単一記述素質問で、当該記述素の H 値が同化連鎖で EPSILON 圏内に到達しない。同化は観測済み記述素（O）からの 1 ホップのみであり、H の変化は伝播しない。

### 修正方針

各質問の effect に「開放記述素」を追加し、偶然の開きの構造にする。

- **開放記述素**: 同化連鎖で H が正解値方向に動く記述素（質問のオープン条件を満たす）
- **anomaly 記述素**: 元の記述素（P_init の予測と矛盾する）

開放記述素の選定基準:
1. ゲーム進行中に H が EPSILON 圏内に到達すること
2. 質問内容との意味的関連があること
3. init_questions の除外条件を満たすこと（has_conflict により除外）

### 開放記述素の分類

| フェーズ | 開放記述素 | H 到達契機 | 対象質問 |
|---------|-----------|-----------|---------|
| P1 初期同化 | Fs-01 (H→1.0) | q01 回答 | q31, q41, q47 |
| P1 初期同化 | Fs-05 (H→1.0) | q13 回答 | q26 |
| P1 初期同化 | Fs-14 (H→1.0) | q06 回答 | q07, q27, q28 |
| P1 初期同化 | Fs-20 (H→1.0) | q09 回答 | q08, q48 |
| P1 初期同化 | Fs-25 (H→1.0) | q10 回答 | q11, q22, q29 |
| P1 初期同化 | Fs-35 (H→0.0) | q37 回答 | q03 |
| P2 以降 | Fs-17 (H→1.0) | q14(q57経由) 回答 | q51 |
| P2 以降 | Ft-05 (H→1.0) | q61 回答 | q52 |
| P4 以降 | Ft-03 (H→1.0) | q53 回答 | q50, q53, q55 |
| P4 以降 | M-01 (H→1.0) | q69(q50経由) 回答 | q69 |

## 対処：全 19 件の修正

### P1 フェーズで開く質問（13 件）

#### q03: Fs-35 開放 + Fs-09 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | 男は喉が渇いていましたか？ | 男は酔っておらず喉も渇いていませんでしたか？ |
| correct | no | yes |
| ans_yes | [(Fs-09, 1)] | [(Fs-35, 0), (Fs-09, 0)] |
| ans_no | [(Fs-09, 0)] | [(Fs-09, 1)] |
| ans_irr | [Fs-09] | [Fs-35, Fs-09] |

**開放記述素**: Fs-35「男は酔っている」(P1 D⁻, pred=0) — q37 回答後 H=0.0

#### q07: Fs-14 開放 + Fs-16 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | バーテンダーは男を脅そうとしましたか？ | バーテンダーは銃を所持していましたが、男を脅す意図はなかったですか？ |
| correct | no | yes |
| ans_yes | [(Fs-16, 1)] | [(Fs-14, 1), (Fs-16, 0)] |
| ans_no | [(Fs-16, 0)] | [(Fs-16, 1)] |
| ans_irr | [Fs-16] | [Fs-14, Fs-16] |

**開放記述素**: Fs-14「バーテンダーは銃を所持」(P1 D⁺, pred=1) — q06 回答後 H=1.0

#### q08: Fs-20 開放 + Fs-18 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | バーテンダーは男に敵意がありましたか？ | 銃は本物でしたが、バーテンダーに男への敵意はなかったですか？ |
| correct | no | yes |
| ans_yes | [(Fs-18, 1)] | [(Fs-20, 1), (Fs-18, 0)] |
| ans_no | [(Fs-18, 0)] | [(Fs-18, 1)] |
| ans_irr | [Fs-18] | [Fs-20, Fs-18] |

**開放記述素**: Fs-20「銃は本物」(P1 D⁺, pred=1) — q09 回答後 H=1.0

#### q11: Fs-25 開放 + Fs-26 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | 男の目的は達成されましたか？ | 男は水を飲まずに帰りましたが、目的は達成されていましたか？ |
| ans_yes | [(Fs-26, 1)] | [(Fs-25, 1), (Fs-26, 1)] |
| ans_no | [(Fs-26, 0)] | [(Fs-26, 0)] |
| ans_irr | [Fs-26] | [Fs-25, Fs-26] |

**開放記述素**: Fs-25「男は水を飲まずに帰った」(P1 D⁺, pred=1) — q10 回答後 H=1.0

#### q22: Fs-25 開放 + Ft-17 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | 水が不要になったのは症状が治ったからですか？ | 男は水を飲まずに帰りましたが、それは症状が治って水が不要になったからですか？ |
| ans_yes | [(Ft-17, 1)] | [(Fs-25, 1), (Ft-17, 1)] |
| ans_no | [(Ft-17, 0)] | [(Ft-17, 0)] |
| ans_irr | [Ft-17] | [Fs-25, Ft-17] |

**開放記述素**: Fs-25 — q10 回答後 H=1.0

#### q26: Fs-05 開放 + Ft-10 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | バーテンダーはその症状の止め方を知っていましたか？ | 男は飲酒目的ではなく来ましたが、バーテンダーはその症状の止め方を知っていましたか？ |
| ans_yes | [(Ft-10, 1)] | [(Fs-05, 1), (Ft-10, 1)] |
| ans_no | [(Ft-10, 0)] | [(Ft-10, 0)] |
| ans_irr | [Ft-10] | [Fs-05, Ft-10] |

**開放記述素**: Fs-05「男は飲酒目的でない」(P1 D⁺, pred=1) — q13 回答後 H=1.0

#### q27: Fs-14 開放 + Ft-11 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | バーテンダーは善意で銃を向けましたか？ | バーテンダーは銃を所持していましたが、善意でそれを使いましたか？ |
| ans_yes | [(Ft-11, 1)] | [(Fs-14, 1), (Ft-11, 1)] |
| ans_no | [(Ft-11, 0)] | [(Ft-11, 0)] |
| ans_irr | [Ft-11] | [Fs-14, Ft-11] |

**開放記述素**: Fs-14 — q06 回答後 H=1.0

#### q28: Fs-14 開放 + Ft-13 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | 銃を向けた目的は男を驚かせることでしたか？ | バーテンダーは銃を使って男を驚かせようとしましたか？ |
| ans_yes | [(Ft-13, 1)] | [(Fs-14, 1), (Ft-13, 1)] |
| ans_no | [(Ft-13, 0)] | [(Ft-13, 0)] |
| ans_irr | [Ft-13] | [Fs-14, Ft-13] |

**開放記述素**: Fs-14 — q06 回答後 H=1.0

#### q29: Fs-25 開放 + Ft-15 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | 驚かせることで男の問題は解決しましたか？ | 男は水を飲まずに帰りましたが、驚かされて問題が解決したからですか？ |
| ans_yes | [(Ft-15, 1)] | [(Fs-25, 1), (Ft-15, 1)] |
| ans_no | [(Ft-15, 0)] | [(Ft-15, 0)] |
| ans_irr | [Ft-15] | [Fs-25, Ft-15] |

**開放記述素**: Fs-25 — q10 回答後 H=1.0

#### q31: Fs-01 開放 + Ft-19 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | 男はバーテンダーの意図を理解しましたか？ | 男は飲み物を求めて来ましたが、最終的にバーテンダーの意図を理解しましたか？ |
| ans_yes | [(Ft-19, 1)] | [(Fs-01, 1), (Ft-19, 1)] |
| ans_no | [(Ft-19, 0)] | [(Ft-19, 0)] |
| ans_irr | [Ft-19] | [Fs-01, Ft-19] |

**開放記述素**: Fs-01「男は飲み物を求めて来た」(P1 D⁺, pred=1) — q01 回答後 H=1.0

#### q41: Fs-15→Fs-01 開放記述素置換

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | バーテンダーの行動は男の注文を聞いた結果ですか？ | 男が飲み物を求めて注文した際、バーテンダーはその話し方から何かに気づきましたか？ |
| ans_yes | [(Fs-15, 1), (Ft-09, 1)] | [(Fs-01, 1), (Ft-09, 1)] |
| ans_no | [(Fs-15, 0)] | [(Fs-01, 0)] |
| ans_irr | [Fs-15] | [Fs-01] |

**修正理由**: Fs-15 は H=0.5 のまま到達不能。Fs-01 (H=1.0) に置換。

#### q47: Fs-01 開放 + B-02 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | 銃を向けた行為と水の注文は、見た目とは異なる形で関係がありますか？ | 男が飲み物を求めて来たことと銃を向けた行為は、見た目とは異なる形で関係がありますか？ |
| ans_yes | [(B-02, 1)] | [(Fs-01, 1), (B-02, 1)] |
| ans_no | [(B-02, 0)] | [(B-02, 0)] |
| ans_irr | [B-02] | [Fs-01, B-02] |

**開放記述素**: Fs-01 — q01 回答後 H=1.0

#### q48: Fs-20 開放 + B-03 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | 男が感謝したのは、銃を向ける行為に助けの意味があったからですか？ | 銃は本物でしたが、その行為に助けとしての意味がありましたか？ |
| ans_yes | [(B-03, 1)] | [(Fs-20, 1), (B-03, 1)] |
| ans_no | [(B-03, 0)] | [(B-03, 0)] |
| ans_irr | [B-03] | [Fs-20, B-03] |

**開放記述素**: Fs-20 — q09 回答後 H=1.0

### P2 以降で開く質問（2 件）

#### q51: Fs-17 開放 + M-02 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | バーテンダーの行動には、男の問題を治す意図がありましたか？ | バーテンダーは男を助けようとしましたが、その行動には問題を治す具体的な意図がありましたか？ |
| ans_yes | [(M-02, 1)] | [(Fs-17, 1), (M-02, 1)] |
| ans_no | [(M-02, 0)] | [(M-02, 0)] |
| ans_irr | [M-02] | [Fs-17, M-02] |

**開放記述素**: Fs-17「バーテンダーは男を助けようとした」— q14 回答後 H=1.0

#### q52: Ft-05 開放 + M-04 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | バーテンダーが水以外の方法で対処したのは合理的でしたか？ | 水を頼んだのは症状への対処でしたが、バーテンダーが水以外の方法で対処したのは合理的でしたか？ |
| ans_yes | [(M-04, 1)] | [(Ft-05, 1), (M-04, 1)] |
| ans_no | [(M-04, 0)] | [(M-04, 0)] |
| ans_irr | [M-04] | [Ft-05, M-04] |

**開放記述素**: Ft-05「水を頼んだのは症状に関係がある」— q61 回答で観測、P1→P2 シフト時に H=1.0

### P4 以降で開く質問（4 件）

#### q50: Ft-03 開放 + M-03 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | バーテンダーは男の様子から問題に気づくことができましたか？ | 男は症状を止めたがっていましたが、バーテンダーはその様子から問題に気づきましたか？ |
| ans_yes | [(M-03, 1)] | [(Ft-03, 1), (M-03, 1)] |
| ans_no | [(M-03, 0)] | [(M-03, 0)] |
| ans_irr | [M-03] | [Ft-03, M-03] |

**開放記述素**: Ft-03「男はその症状を止めたかった」— q53 回答後 H=1.0（P4 同化経路: Ft-05→Ft-13→...→Ft-03）

#### q53: Ft-03 開放 + B-05 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | バーテンダーは男の問題に対する具体的な知識を持っていましたか？ | 男は症状を止めたがっていましたが、バーテンダーはその問題に対する具体的な知識を持っていましたか？ |
| ans_yes | [(B-05, 1)] | [(Ft-03, 1), (B-05, 1)] |
| ans_no | [(B-05, 0)] | [(B-05, 0)] |
| ans_irr | [B-05] | [Ft-03, B-05] |

**開放記述素**: Ft-03 — P4 シフト時に H≈0.9 (Ft-10→B-05 関係で同化)

**注**: q53 が回答されると Ft-03 が観測され H=1.0 になり、q50 が開く連鎖構造。

#### q55: Ft-03 開放 + M-05 anomaly

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | 驚きや恐怖が男の身体的な症状に影響を与えましたか？ | 男は症状を止めたがっていましたが、驚きや恐怖がその症状に影響を与えましたか？ |
| ans_yes | [(M-05, 1)] | [(Ft-03, 1), (M-05, 1)] |
| ans_no | [(M-05, 0)] | [(M-05, 0)] |
| ans_irr | [M-05] | [Ft-03, M-05] |

**開放記述素**: Ft-03 — P4 シフト時に H≈0.9

#### q69: M-11→M-01 開放記述素置換

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| text | 突然発症した問題は、バーテンダーにも気づかれるものでしたか？ | 男の身体的な問題は水で対処できるものでしたが、バーテンダーにも気づかれましたか？ |
| ans_yes | [(M-11, 1), (M-03, 1)] | [(M-01, 1), (M-03, 1)] |
| ans_no | [(M-11, 0)] | [(M-01, 0), (M-03, 0)] |
| ans_irr | [M-11] | [M-01, M-03] |

**修正理由**: M-11 は H=0.5 のまま到達不能。M-01 (q69(q50経由) 回答で H=1.0) に置換。

## 再検証

### anomaly_discovery.py 実行結果

修正後に anomaly_discovery.py を再実行:

- **Part 1**: OK（anomaly 質問が初期オープンに含まれない）
- **Part 2**: 47/47 発掘可能 — **OK**

### 発掘連鎖の概要

```
Step  1: q01 回答 → Fs-01 観測 → q31, q41, q47 等 8件発掘
Step  3: q06 回答 → Fs-14 観測 → q07, q27, q28 発掘
Step  4: q09 回答 → Fs-20 観測 → q08, q48 発掘
Step  5: q10 回答 → Fs-25 観測 → q11, q22, q29 発掘
Step  6: q13 回答 → Fs-05 観測 → q26 等 3件発掘
Step  7: q37 回答 → Fs-35 観測 → q03 発掘
Step 13: q56 回答 → Fs-10 観測 → q04, q43 発掘
Step 14: q58 回答 → Fs-19 観測 → q15 発掘
Step 15: q59 回答 → Fs-22 観測 → q16 発掘
Step 16: q61 回答 → P1→P2 シフト → q17, q21, q42, q45, q52, q65 発掘
Step 17: q62 回答 → q23, q64 発掘
Step 27: q57 回答 → Fs-17 観測 → q14, q51 発掘
Step 28: q60 回答 → Ft-01 観測 → q18, q63 発掘
Step 29: q03 回答 → P2→P4 シフト → q30, q46, q53, q54, q55, q66 発掘
Step 46: q30 回答 → q44 発掘
Step 48: q53 回答 → Ft-03 観測 → q20, q50 発掘
Step 56: q50 回答 → M-03 観測 → q69 発掘
Step 57: q69 回答 → M-01 観測 → q49 発掘
```

### init_questions への影響

修正後の全 19 質問について、init_questions の除外条件を確認:

- **has_match + has_conflict パターン**（17 件）: effect に P1 予測一致と矛盾の両方を含むため除外
- **has_conflict only パターン**（2 件: q51, q52）: effect が P1 予測と全て矛盾するため除外（has_match=False）

初期オープン質問数は修正前後で変化なし（9 件）。

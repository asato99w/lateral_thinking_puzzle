# 検証（Phase 4）

使用規則: 補完検証、多層構造検証、シフト方向検証、不足ルーティング

## 適用概要

Phase 3 までの出力（記述素空間、パラダイム群、質問群）に対し、4 つの検証を行う。

---

## Step 4a: 補完検証（アノマリー導入質問の検証）

### アノマリー記述素の完全カバレッジ

各パラダイム P_i（T を除く）のアノマリー記述素が、いずれかの質問の effect でカバーされていること。

| パラダイム | アノマリー数 | カバー質問 | 完全性 |
|-----------|------------|-----------|--------|
| P1 | 9 | q18(Fs-11), q19(Fs-12), q20(Fs-15,16), q21(Fs-18,20), q22(Fs-19), q23(Fs-22), q24(Fs-06) | 9/9 ✓ |
| P2 | 4 | q29(Fs-27), q30(Fs-30), q31(Fs-35), q32(Fs-36) | 4/4 ✓ |
| P3 | 2 | q44(D-04), q45(Ft-50) | 2/2 ✓ |
| P4 | 1 | q58(Ft-34) | 1/1 ✓ |

**判定: OK**（全 16 アノマリー記述素がカバーされている）

---

## Step 4b: 補完検証（同化接続性・動的発掘連鎖）

### 同化接続性

各遷移後に、Consistent(O, P') から R(P') 経由で新規質問の effect 記述素に到達可能であること。

| 遷移 | P1 由来の Consistent 記述素 | ゲート辺 | 到達先 | 新規オープン | 判定 |
|------|--------------------------|---------|--------|------------|------|
| P1→P2 | Fs-06,11,12,15,16,18,19,20,22 | Fs-12→Fs-26 | Fs-26→Fs-24→Fs-38→Fs-34 | q25-q32 | OK |
| P2→P3 | Fs-27,30,35,36 | （不要） | Fs-27→Ft-23→Ft-22→Ft-37; Fs-38→D-01→D-02→D-03 | q33-q45 | OK |
| P3→P4 | D-04, Ft-50 | Ft-50→Pt-1, D-04→D-07 | Pt-1→Pt-2→...; D-07→Ft-28 | q46-q58 | OK |
| P4→P5 | Ft-34 | Ft-34→Pt-6, Ft-28→Ft-29 | Pt-6→Ft-29→Ft-40→Ft-42 | q59-q65 | OK |

**判定: OK**（全遷移で同化接続性あり）

### 動的発掘連鎖

初期オープン質問からの O 更新により、質問の段階的オープンが成立すること。

#### シミュレーション概要

初期状態: P1 アクティブ、O = Ps 値、init_question_ids = {q01-q06, q11-q17, q67, q68}

**フェーズ 1: P1 の横方向探索**

```
[ステップ 1] init_questions オープン（15 問）
  q01(Fs-01), q02(Fs-14), q03(Fs-17), q04(Fs-21), q05(Fs-39), q06(Fs-44)
  q11-q17（否定仮説）, q67(B-01), q68(B-02)

[ステップ 2] q01 回答 → Fs-01=1 を O に追加
  Consistent(O,P1) に Fs-01 追加
  R(P1) 到達: Fs-01→Fs-02→Fs-03, Fs-01→Fs-05
  → q07〜q10 は prereq 未充足のためまだ非オープン

[ステップ 3] q02 回答 → Fs-14=1 を O に追加
  R(P1) 到達: Fs-14→Fs-09(safe)
  q18(prereq:Fs-14)の effect Fs-09 が consistent_reach 内 → q18 オープン
  同様に q19(prereq:Fs-14), q20(prereq:Fs-14) オープン

[ステップ 4] q03 回答 → Fs-17=1 を O に追加
  R(P1) 到達: Fs-17→Fs-18(P1=0)→到達不可(3a), Fs-17→Fs-23(safe)
  q07(prereq:Fs-17) オープン
  q21(prereq:Fs-17), q22(prereq:Fs-17) オープン

[ステップ 5] q04 回答 → Fs-21=1 を O に追加
  q23(prereq:Fs-21) オープン

[ステップ 6] q18-q23 への回答によりアノマリー蓄積
  q19 回答 → Fs-12=1 が O に（P1 ではアノマリー）
  → q24(prereq:Fs-12) オープン, q25(prereq:Fs-12) オープン
  q21 回答 → Fs-18=1, Fs-20=1 が O に（アノマリー）
  ...
```

**フェーズ 2: P1→P2 シフト**

十分なアノマリー蓄積（3 個以上の anomaly 記述素）で tension 増加 → P2 が shift 候補に:
- tension(O, P2) < tension(O, P1): P2 は P1 の anomaly を全て resolve するため tension が低い
- resolve(O, P1, P2) ≥ N(P2): P1 の anomaly が P2 で全て解消されるため高い resolve

**フェーズ 3: P2 の探索**

P1→P2 シフト後、ゲート辺 Fs-12→Fs-26 により Fs-26 が consistent_reach に入り、q25 がオープン。以降 q26-q32 が段階的にオープン。

**フェーズ 4〜6**: 同様に P2→P3, P3→P4, P4→P5 と遷移し、最終的に q66（完全解答）に到達可能。

**判定: OK**（発掘連鎖は初期オープンから完全解答まで接続している）

注: 詳細なシミュレーションは excavation_chain.py で検証。

---

## Step 4c: 多層構造検証

### 条件 1: 層0のアノマリー比率（≤ 0.3）

| パラダイム | 層0のアノマリー質問数 | 全アノマリー質問数 | 比率 | 判定 |
|-----------|--------------------|--------------------|------|------|
| P1 | 0 | 7 | 0.00 | OK |
| P2 | 0 | 4 | 0.00 | OK |
| P3 | 0 | 2 | 0.00 | OK |
| P4 | 0 | 1 | 0.00 | OK |
| S1 | 1 | 1 | 1.00 | N/A（行き止まり） |
| S2 | 1 | 1 | 1.00 | N/A（行き止まり） |

S1, S2 は即時否定の行き止まりパラダイムであり、段階的発見を目的としない。本条件の検証対象外とする。

**判定: OK**（メインパス全パラダイムで条件充足）

### 条件 2: 十分な層深度（推奨 ≥ 2）

| パラダイム | アノマリーの最小層 | 最大層 | 判定 |
|-----------|------------------|--------|------|
| P1 | 1 | 2 | △（推奨 2 に対し最小 1） |
| P2 | 1 | 1 | △ |
| P3 | 1 | 1 | △ |
| P4 | 1 | 1 | △ |

全パラダイムで最小アノマリー深度が 1。推奨値 2 に対して 1 段浅い。

**評価**: 各パラダイムに層 0（safe 探索）→ 層 1（アノマリー導入）の 2 段階構造が存在し、中間的な認知ステップ（prerequisites による段階的開放）は機能している。P1 は層 2（q24）も持ち、最も段階的な構造を持つ。

P2〜P4 は各パラダイム内のアノマリー数が少なく（4, 2, 1 個）、さらなる層分割は質問の自然さを損なう可能性がある。ゲーム全体としては P1(depth 0) → P2(depth 1) → P3(depth 2) → P4(depth 3) → P5(depth 4) の 5 段階深化が存在し、パラダイム間を通じた段階的発見プロセスは成立している。

**判定: 許容**（推奨値未達だが、パラダイム横断の深化構造で補完される）

### 条件 3: ボトルネックの制限

| パラダイム | アノマリーへの独立経路 | ボトルネック | 判定 |
|-----------|--------------------|-----------:|------|
| P1 | 2（注文動機グループ / 味覚反応グループ） | なし | OK |
| P2 | 2（Fs-26 系 / Fs-34 系） | なし | OK |
| P3 | 2（D-03 系 / Fs-61 系） | なし | OK |
| P4 | 1（D-07 → Ft-28 → q58） | **あり** | ⚠️ |

**P4 のボトルネック**: Ft-34 へのアノマリー到達が D-07 → Ft-28 の単一経路に依存。ただし、P4 には唯一のアノマリー（Ft-34）しかなく、ボトルネックの影響は限定的である。D-07 と Ft-28 は複数の質問で到達可能（q53→D-07, q54→Ft-28）であり、これらの質問自体は層 0 で到達可能。

**判定: 許容**（P4 に単一経路リスクがあるが、当該経路の到達性は安定しており実用上問題なし）

### 条件 4: アノマリーの層分散（≥ 2 層）

| パラダイム | アノマリーが存在する層数 | 判定 |
|-----------|----------------------|------|
| P1 | 2（層 1, 層 2） | OK |
| P2 | 1（層 1 のみ） | △ |
| P3 | 1（層 1 のみ） | △ |
| P4 | 1（層 1 のみ） | △ |

**評価**: P2〜P4 はアノマリー数が少ないため単一層集中は構造的に不可避。P1 は最多のアノマリー（9 個）を持ち、2 層に分散できている。tension の段階的蓄積は P1 の 2 層構造で主に実現され、P2〜P4 では各遷移自体が段階的深化を担う。

**判定: 許容**（P1 で条件充足、P2〜P4 はパラダイム間深化で補完）

### 多層構造検証の総合判定

| 条件 | 結果 | 備考 |
|------|------|------|
| 条件 1（層0比率） | **OK** | 全メインパスで 0% |
| 条件 2（層深度） | **許容** | 最小 1、パラダイム横断で補完 |
| 条件 3（ボトルネック） | **許容** | P4 に単一経路、実用上問題なし |
| 条件 4（層分散） | **許容** | P1 で OK、P2-P4 はパラダイム間で補完 |

**差し戻し不要**: 条件 1 が完全充足し、条件 2〜4 の推奨値未達は構造的に正当化される。

---

## Step 4d: シフト方向検証

### Step 4d-1: 静的分析（P_pred 比較による 4 分類）

#### P1→P2 遷移

**駆動質問（anomaly_count > 0）の分類**:

| 質問 | effect（正答時） | P1 anomaly_count | P2 support | P2 oppose | net_dir | 分類 |
|------|----------------|-----------------|-----------|----------|---------|------|
| q18 | Fs-09=1, Fs-11=1 | 1 (Fs-11) | 2 | 0 | +2 | 遷移駆動 |
| q19 | Fs-14=1, Fs-12=1 | 1 (Fs-12) | 2 | 0 | +2 | 遷移駆動 |
| q20 | Fs-14=1, Fs-15=1, Fs-16=1 | 2 (Fs-15,16) | 3 | 0 | +3 | 遷移駆動 |
| q21 | Fs-17=1, Fs-18=1, Fs-20=1 | 2 (Fs-18,20) | 3 | 0 | +3 | 遷移駆動 |
| q22 | Fs-17=1, Fs-19=1 | 1 (Fs-19) | 2 | 0 | +2 | 遷移駆動 |
| q23 | Fs-21=1, Fs-22=1 | 1 (Fs-22) | 2 | 0 | +2 | 遷移駆動 |
| q24 | Fs-05=1, Fs-06=1 | 1 (Fs-06) | 2 | 0 | +2 | 遷移駆動 |

**安全質問（anomaly_count = 0）の分類**:

| 質問群 | 数 | P2 net_dir | 分類 |
|--------|---|-----------|------|
| q01-q06（基本事実） | 6 | +1 each | 方向支持 |
| q07-q10（探索） | 4 | +1 each | 方向支持 |
| q11-q17（否定仮説） | 7 | +1 each | 方向支持 |

P2 は P1 の P_pred を全て包含するため、全ての安全質問が P2 方向を支持する。

**集計**:

| 分類 | 質問数 | 割合 |
|------|--------|------|
| 遷移駆動 | 7 | 29% |
| 方向支持 | 17 | 71% |
| 中立 | 0 | 0% |
| 駆動・逆方向 | 0 | 0% |

**指標**:

| 指標 | 値 | 条件 | 判定 |
|------|---|------|------|
| 遷移方向スコア | +1.00 | > 0 (S1) | OK |
| 駆動率 | 1.00 | > 0.5 (S2) | OK |
| 遷移駆動サイズ | 7 | 十分 (S3) | OK |

**スキップリスク（S4）**:

P1 の shift_candidates = [P2, S1, S2]。各候補への方向スコア:

| 候補 | anomaly 質問の net_dir 合計 | safe 質問の net_dir 合計 | 方向スコア |
|------|---------------------------|------------------------|-----------|
| P2 | +16 | +17 | +1.00 |
| S1 | -5（Fs-12,16,18,20 等が oppose） | 低い（多数が不定で support=0） | 低い |
| S2 | +1（Fs-12,15,16 等が partial support） | 低い | 低い |

P2 の方向スコアが S1, S2 を大きく上回り、スキップリスクなし。

**P1→P2 判定: 全条件 OK**

#### P2→P3 遷移

**駆動質問**:

| 質問 | effect | P2 anomaly | P3 support | net_dir | 分類 |
|------|--------|-----------|-----------|---------|------|
| q29 | Fs-26=1, Fs-27=1 | 1 (Fs-27) | 2 | +2 | 遷移駆動 |
| q30 | Fs-34=1, Fs-30=1 | 1 (Fs-30) | 2 | +2 | 遷移駆動 |
| q31 | Fs-38=1, Fs-35=1 | 1 (Fs-35) | 2 | +2 | 遷移駆動 |
| q32 | Fs-34=1, Fs-36=1 | 1 (Fs-36) | 2 | +2 | 遷移駆動 |

**安全質問**: q25-q28（4 問）= 全て方向支持

| 指標 | 値 | 判定 |
|------|---|------|
| 遷移方向スコア | +1.00 | OK |
| 駆動率 | 1.00 | OK |
| 遷移駆動サイズ | 4 | OK |
| スキップリスク | なし（P2→P3 の唯一候補） | OK |

**P2→P3 判定: 全条件 OK**

#### P3→P4 遷移

**駆動質問**:

| 質問 | effect | P3 anomaly | P4 support | net_dir | 分類 |
|------|--------|-----------|-----------|---------|------|
| q44 | D-03=1, D-04=1 | 1 (D-04) | 2 | +2 | 遷移駆動 |
| q45 | Fs-61=1, Ft-50=1 | 1 (Ft-50) | 2 | +2 | 遷移駆動 |

**安全質問**: q33-q43（11 問）= 全て方向支持

| 指標 | 値 | 判定 |
|------|---|------|
| 遷移方向スコア | +1.00 | OK |
| 駆動率 | 1.00 | OK |
| 遷移駆動サイズ | 2 | やや少ないが P3→P4 は唯一候補で十分 |
| スキップリスク | なし | OK |

**P3→P4 判定: OK**

#### P4→P5 遷移

**駆動質問**:

| 質問 | effect | P4 anomaly | P5 support | net_dir | 分類 |
|------|--------|-----------|-----------|---------|------|
| q58 | Ft-28=1, Ft-34=1 | 1 (Ft-34) | 2 | +2 | 遷移駆動 |

**安全質問**: q46-q57（12 問）= 全て方向支持

| 指標 | 値 | 判定 |
|------|---|------|
| 遷移方向スコア | +1.00 | OK |
| 駆動率 | 1.00 | OK |
| 遷移駆動サイズ | 1 | 最小限だが P4→P5 は唯一候補 |
| スキップリスク | なし | OK |

**P4→P5 判定: OK**

#### サブパラダイムの方向検証

**S1**: Q(S1) = {q67}（B-01 のアノマリー質問のみ）。B-01=0 が O に入ると即座に Anomaly(O, S1) が増大し、S1 は行き止まりとして機能。P1 に戻る方向が正しい。

**S2**: Q(S2) = {q68}（B-02 のアノマリー質問のみ）。同様に即座にアノマリー → P1 に戻る。

### Step 4d-2: 動的検証（概略）

各遷移についてシミュレーション想定:

#### P1→P2 動的検証

1. P1 アクティブ、init_questions 回答開始
2. q18-q24 のうち 2〜3 問に回答 → anomaly 蓄積（例: Fs-11, Fs-12, Fs-15 が O に）
3. tension(O, P1) > 0（anomaly 3 個以上）
4. shift 候補評価:
   - P2: neighbors ✓, tension(O, P2) < tension(O, P1) ✓（P2 は全 anomaly を resolve）
   - resolve(O, P1, P2) = 3+ ≥ N(P2) ✓
   - S1: resolve(O, P1, S1) ≤ 1（Fs-19 のみ） → N(S1) 未充足の可能性
   - S2: resolve(O, P1, S2) ≤ 4（部分的）→ P2 が上回る
5. select_shift_target: resolve DESC → P2 が最大 → **P2 選択** ✓

#### P2→P3 動的検証

1. P2 アクティブ、q25-q28 回答後に q29-q32 オープン
2. q29-q32 のうち 1〜2 問に回答 → anomaly 蓄積
3. shift 候補: P3 のみ
4. resolve(O, P2, P3) ≥ N(P3) → **P3 選択** ✓

#### P3→P4, P4→P5 動的検証

同様のパターン。各フェーズで唯一の遷移先を持つため方向の誤りなし。

### 静的分析の総括

| 遷移 | 方向スコア | 駆動率 | スキップリスク | 診断 |
|------|----------|--------|--------------|------|
| P1→P2 | 1.00 | 1.00 | なし | 頑健な遷移 |
| P2→P3 | 1.00 | 1.00 | なし | 頑健な遷移 |
| P3→P4 | 1.00 | 1.00 | なし | 頑健な遷移 |
| P4→P5 | 1.00 | 1.00 | なし | 頑健な遷移 |

**構造的特徴**: 各パラダイムが前段の P_pred を包含する入れ子構造のため、方向スコアと駆動率が最大値となる。これは「ウミガメのスープ」問題の物語構造（日常→過去→嘘→極限→真実 という累積的深化）に由来する。

**Step 4d 判定: 全遷移 OK**

---

## Step 4e: 不足ルーティング

### 検証結果の集約

| 検証 | 結果 | 不足 |
|------|------|------|
| 4a: アノマリー導入質問 | OK | なし |
| 4b: 同化接続性・発掘連鎖 | OK | なし |
| 4c-1: 層0比率 | OK | なし |
| 4c-2: 層深度 | 許容 | 推奨値未達（最小 1 vs 推奨 2） |
| 4c-3: ボトルネック | 許容 | P4 に単一経路 |
| 4c-4: 層分散 | 許容 | P2-P4 で 1 層集中 |
| 4d: シフト方向（静的） | OK | なし |
| 4d: シフト方向（動的） | OK（想定） | なし |

### 差し戻し判定

**差し戻しなし**。

条件 4c-2〜4c-4 の推奨値未達は以下の理由により許容:
1. P2〜P4 のアノマリー数が少ない（4, 2, 1 個）ため、パラダイム内での多層分散は構造的に困難
2. パラダイム横断で 5 段階深化（depth 0→4）が成立しており、ゲーム全体としての段階的発見は保証されている
3. P1 は 9 個のアノマリーを 2 層に分散しており、最も重要なフェーズで条件を充足

### 収束判定

Phase 4 の検証を通過。反復不要。形式化（JSON 変換）に進む。

---

## スクリプトによる検証（形式化後に実行）

JSON データ生成後に以下のスクリプトで機械的に検証する:

| スクリプト | 検証内容 | 対応 Phase |
|-----------|---------|-----------|
| paradigm_qp.py | Q(P) 構造、層構造、アノマリー比率 | 4c |
| shift_direction.py | シフト方向の動的検証 | 4d |
| assimilation_connectivity.py | 同化接続性 | 4b |
| excavation_chain.py | 動的発掘連鎖 | 4b |
| transition_drive.py | 遷移方向スコア・駆動率 | 4d |

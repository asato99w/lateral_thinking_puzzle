# 検証と反復（Phase 4）

使用規則: 補完検証、多層構造検証、シフト方向検証、不足ルーティング

---

## Step 4a: 補完検証（静的到達性）

各パラダイムの anomaly 到達性を静的に検証する。

### P1（anomaly = 9）

- P_pred 固有記述素: あり（Fs-01, Fs-03, Fs-05 等）✓
- R(P1) 接続性: 横辺 11 + ゲート辺 1 = 12 辺 ✓
- anomaly 上界: 9 ✓

### P2（anomaly = 4）

- P_pred 固有記述素: あり（Fs-12, Fs-14 等）✓
- R(P2) 接続性: 横辺 7 + ゲート辺 3 = 10 辺 ✓
- anomaly 上界: 4 ✓

### P3（anomaly = 2）

- P_pred 固有記述素: あり（Ft-37, Fs-41 等）✓
- R(P3) 接続性: 横辺 7 + ゲート辺 1 = 8 辺 ✓
- anomaly 上界: 2 ✓

### P4（anomaly = 1）

- P_pred 固有記述素: あり（Ft-01, Ft-07 等）✓
- R(P4) 接続性: 横辺 12 + ゲート辺 1 = 13 辺 ✓
- anomaly 上界: 1 ✓

**静的到達性: 全パラダイム OK ✓**

---

## Step 4b: 補完検証（動的発掘連鎖）

同化連鎖による anomaly の動的発掘をシミュレーションする。

### P1 フェーズのシミュレーション

1. 初期状態: O = Ps, H は P1 に集中
2. 層0 の safe 質問を回答 → P1 の D⁺ 記述素が確定、H の P1 集中が強化
3. 層0→層1 のゲート辺 (Ps-6→Fs-39) により Fs-39 の H が閾値に到達
4. Fs-39 関連の質問がオープン → Fs-39=1 が確定（P1 アノマリー）
5. Fs-19→Fs-26 のゲート辺により Fs-26 の H が閾値に到達
6. Fs-26 関連の質問がオープン → Fs-26=1 が確定（P1 アノマリー）
7. tension(O, P1) = 2 時点で Fs-40, Ft-37 への経路が開く
8. さらに anomaly が蓄積 → 3 条件（近傍、tension strict <、resolve >= N）を満たしシフト発動

**発掘可能 anomaly: 9/9（全数）** ✓

**注意点:** Fs-27（飲まされた）の動的到達性について、Fs-26 → Fs-27 の補強辺（w=0.8）により、Fs-26 確定後に Fs-27 の H が十分に上昇する（06_前提事実適用で確認済み）。

### P2〜P4 フェーズ

P2 以降はアノマリー数が少なく（4, 2, 1）、各フェーズの anomaly が少数であるため発掘連鎖の断絶リスクは低い。

- P2: Ft-37 は Fs-26（D⁺）から直接到達 → 発掘可能 ✓
- P3: Ft-03 は Ft-22（D⁺）からゲート辺で到達 → 発掘可能 ✓
- P4: Ft-47 は Ft-28（D⁺）から直接到達 → 発掘可能 ✓

**動的発掘連鎖: 全パラダイム OK ✓**

---

## Step 4c: 多層構造検証

Q(P) の層構造品質を検証する。

### 条件 1: 層0のアノマリー比率

| パラダイム | 層0 anomaly | 全 anomaly | 比率 | 判定（≤0.3） |
|-----------|-----------|-----------|------|------------|
| P1 | 0 | 9 | 0.00 | ✓ |
| P2 | 0 | 4 | 0.00 | ✓ |
| P3 | 0 | 2 | 0.00 | ✓ |
| P4 | 0 | 1 | 0.00 | ✓ |

層0 にアノマリー質問は配置されていない ✓

### 条件 2: 十分な層深度

| パラダイム | min_anomaly_depth | 判定（≥2） |
|-----------|------------------|-----------|
| P1 | 1（Fs-39 は層1） | △ |
| P2 | 1（Ft-37 は層1） | △ |
| P3 | 1（Ft-03 は層1） | △ |
| P4 | 1（Ft-47 は層1） | △ |

**考察:** 全パラダイムで min_anomaly_depth = 1 であり、推奨値 2 を満たさない。ただし:

- P1: 層1 のアノマリー（Fs-39）は偶然の開き構造を持ち、safe 記述素の確定と同時にオープンする設計。層2, 層3 にもアノマリーが分散しており、段階的な発見は実現される。
- P2〜P4: アノマリー数が少ないため、1〜2 個のアノマリーで即遷移する設計。深い層構造は構造的に不要。

**判定: 条件付きで許容。** P1 の層1 アノマリー（Fs-39）については、偶然の開きにより safe 質問と同時に到達する設計であり、「前提なしで即座にアノマリーに遭遇」する問題は生じない。

### 条件 3: ボトルネックの制限

| パラダイム | ボトルネック質問 | 判定 |
|-----------|----------------|------|
| P1 | なし（Fs-39 経路と Fs-26 経路が独立） | ✓ |
| P2 | Fs-26 がほぼ全経路の起点だが D⁺ のため到達は堅牢 | ✓ |
| P3 | Ft-22 が起点だが D⁺ のため到達は堅牢 | ✓ |
| P4 | Ft-28 が起点だが D⁺ のため到達は堅牢 | ✓ |

P2〜P4 は構造的にボトルネックが存在するが、起点が D⁺ 記述素であるため到達の堅牢性は保証される ✓

### 条件 4: アノマリーの層分散

| パラダイム | anomaly 分布層 | 層数 | 判定（≥2） |
|-----------|-------------|------|-----------|
| P1 | 層1, 層2, 層3 | 3 | ✓ |
| P2 | 層1, 層2 | 2 | ✓ |
| P3 | 層1 | 1 | △ |
| P4 | 層1 | 1 | △ |

P3, P4 はアノマリー数自体が少ない（2個, 1個）ため、複数層への分散が構造的に困難。アノマリー数が少ないため単一層での即遷移は許容される。

**多層構造検証: 条件付きで通過 ✓**

---

## Step 4d: シフト方向検証

### 静的分析（遷移駆動集合）

transition_drive.py の実行結果に基づく。

#### メインパス遷移

| 遷移 | |Q(P_from)| | 方向スコア | 駆動率 | 遷移駆動数 | 判定 |
|------|-----------|----------|---------|---------|--------|
| P1→P2 | 53 | +0.5833 | 0.1852 | 5 | S1✓ S2✗ S3✓ |
| P2→P3 | 28 | +0.6250 | 0.5000 | 3 | S1✓ S2✓ S3✓ |
| P3→P4 | 19 | +1.0000 | 1.0000 | 3 | S1✓ S2✓ S3✓ |
| P4→P5 | 27 | +1.0000 | 1.0000 | 2 | S1✓ S2✓ S3✓ |

**条件 S1（方向スコア正値）:** 全遷移で正値 ✓

**条件 S2（駆動率 > 0.5）:**
- P1→P2: 駆動率 0.1852 **✗**（アノマリー質問 27 中、遷移駆動 5、駆動・逆方向 22）
- P2→P3: 駆動率 0.5000 ✓（境界値）
- P3→P4, P4→P5: 駆動率 1.0000 ✓

**P1→P2 の駆動率が低い原因:** P1 のアノマリー質問の多くが P4/P5 の P_pred と整合するため、P2 ではなく P4/P5 方向を支持する「駆動・逆方向」に分類される。これは P4/P5 の P_pred が P1〜P3 をほぼ包含する構造に起因する。

**条件 S3（遷移の十分性）:** 全遷移で遷移駆動数が十分 ✓

**条件 S4（スキップリスク）:**

P1 からの全候補方向スコア:

| 遷移先 | 方向スコア |
|--------|----------|
| P4 | +1.0000 |
| P5 | +1.0000 |
| P3 | +0.7143 |
| P2 | +0.5833 ★（期待遷移先） |
| S1 | +0.0000 |
| S2 | -0.2000 |

**P1→P2 にスキップリスクあり:** P4, P5, P3 が P2 よりも高い方向スコアを持つ。P1 のアノマリーに遭遇した時、P2 を飛び越えて P3 以降に直接向かう可能性がある。

**対処の評価:**
- P2 の引力は prerequisites と所属パラダイム制約により動的に確保される。P3 以降の記述素（Ft-22, Ft-03 等）は P1 フェーズではオープンしないため、静的な方向スコアが高くても実際のシフト先は P2 に制約される。
- 動的検証（Step 4d 後半）でシフト先の一致を確認する。

### 動的検証（シミュレーション）

shift_direction.py の実行結果に基づく。

#### P1 フェーズ

1. safe 質問から回答開始
2. anomaly 質問を発掘順に回答
3. 各回答後に 3 条件（近傍、tension strict <、resolve >= N）を評価
4. 候補から resolve DESC → attention DESC → pid ASC で **P2 が選択される** ✓
5. マージン: P2 の resolve と次点の差が十分 ✓

#### P2〜P4 フェーズ

各フェーズで同様にシミュレーションし、期待するシフト先と一致:

| フェーズ | シフト先 | 一致 | マージン |
|---------|---------|------|---------|
| P1→P2 | P2 | ✓ | > 0.05 ✓ |
| P2→P3 | P3 | ✓ | > 0.05 ✓ |
| P3→P4 | P4 | ✓ | > 0.05 ✓ |
| P4→P5 | P5 | ✓ | > 0.05 ✓ |

**動的検証: 全遷移で通過 ✓**

### シフト方向検証のまとめ

| 条件 | P1→P2 | P2→P3 | P3→P4 | P4→P5 |
|------|--------|--------|--------|--------|
| S1（方向スコア正） | ✓ | ✓ | ✓ | ✓ |
| S2（駆動率>0.5） | ✗(0.19) | ✓(0.50) | ✓(1.00) | ✓(1.00) |
| S3（遷移十分性） | ✓ | ✓ | ✓ | ✓ |
| S4（スキップリスク） | △(あり) | ✓ | ✓ | ✓ |
| D1（シフト先一致） | ✓ | ✓ | ✓ | ✓ |
| D2（マージン） | ✓ | ✓ | ✓ | ✓ |
| D3（候補含有） | ✓ | ✓ | ✓ | ✓ |

**P1→P2 の S2/S4 不充足は既知の構造的問題。** 動的検証（D1〜D3）で通過しており、所属パラダイム制約と prerequisites による動的制御で P2 へのシフトが確保されている。

---

## Step 4e: 不足ルーティング

### 検証結果の集約

| 検証 | 結果 | 不足の種類 |
|------|------|----------|
| 4a: 静的到達性 | 全パラダイム OK | なし |
| 4b: 動的発掘連鎖 | 全パラダイム OK | なし |
| 4c: 多層構造 | 条件付き通過 | P1 の min_anomaly_depth=1（許容） |
| 4d: シフト方向（静的） | P1→P2 の S2/S4 不充足 | 構造的問題（動的に補償） |
| 4d: シフト方向（動的） | 全遷移通過 | なし |

### 不足ルーティング判定

**P1→P2 の静的分析の不充足（S2: 駆動率低、S4: スキップリスク）:**

- 差し戻し先: Phase 3（質問不足）
- 対処: P2 の P_pred にしかない記述素（Fs-12, Fs-14, Ft-36, Ft-38）に関する質問の追加により P2 固有の引力を強化する

**ただし:**

動的検証（D1〜D3）が全遷移で通過しているため、現状の質問群で実際のゲーム進行は正しく機能する。静的分析の不充足は「構造的な脆弱性の指摘」であり、ゲーム品質の改善余地として記録するが、反復の差し戻しは行わない。

### 収束判定

Phase 4 の全検証が通過（条件付き含む）:

- 4a: ✓
- 4b: ✓
- 4c: ✓（条件付き）
- 4d: ✓（静的一部不充足、動的は全通過）

**→ 反復終了。形式化（JSON 変換）に進む。**

---

## 既知の課題（将来の改善候補）

1. **P1→P2 の駆動率向上**: P2 固有の記述素（Fs-12, Ft-36 等）に対応する質問を追加し、P2 方向への静的な引力を強化する
2. **P1 の層深度**: min_anomaly_depth を 2 以上にするため、Fs-39 の prerequisites に中間的な認知ステップを追加する（ただし自然さとのトレードオフ）
3. **P3/P4 のアノマリー分散**: アノマリー数が少ないため構造的に困難だが、中間記述素の追加によりアノマリー数を増やす余地がある

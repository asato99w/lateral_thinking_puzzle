# 禁じられた地下室 v2 検証で発見された構造的問題

サンプル005の検証（v1→v2反復）で、アルゴリズムおよびエンジンの動的計算に関する構造的問題が複数発見された。
いずれも反復的なデータ修正では解決できず、理論レベルでの対処が必要。

<!--
背景: v1検証でR(P)不足→Phase 1差し戻し→R(P)辺追加+p_pred修正→v2検証。
v2でL2-1完全性・L2-5到達パスは改善したが、以下の致命的問題が残存・新規発見された。
-->

## 問題1: 包含連鎖の漏れ、および検証スクリプトの T 特定バグ

2つの独立した問題が混在していた。分離して記録する。

### 問題1a: 基準パス上の Explained 包含連鎖が成立していない

**現象**: `compute_depths`（threshold.py）が算出する depth が想定と異なる。

```
計算結果:
  P1: depth=0, P2: depth=1, P3: depth=0, P4: depth=0, P5: depth=1
想定:
  P1 < P2 < P3 < P4 < P5 の順に深くなるべき
```

**原因**: P5 の p_pred に Fs-23, Fs-96 等の表面事実が含まれていない。

```
          P1_pred   P5_pred   O*
Fs-23       1       None       1   ← P5に予測がない
Fs-96       1       None       1   ← P5に予測がない
```

Explained(P) = {d | P_pred(d) == O*(d)} の包含関係が断絶する:
- Explained(P1) に Fs-23, Fs-96 が含まれる
- Explained(P5) にはこれらが含まれない（p_pred がないため）
- → Explained(P1) ⊄ Explained(P5) → 包含チェーンが切れる

**性質**: p_pred 設計時の単純な漏れ。基準パス上で包含連鎖が成立するかは機械的にチェックできるものであり、反復的対応が必要な問題ではない。

<!--
注: 具体的には、基準パス P1→P2→P3→P4→P5 の各段階で
Explained(P_i) ⊂ Explained(P_{i+1}) を確認すればよい。
不成立の場合、P_{i+1} の p_pred に不足している記述素を追加する。
アルゴリズムの Phase 1（内部構造構成）の手順にこのチェックを追加すべき。
-->

**対処**:
- アルゴリズム: Phase 1 の p_pred 設計手順に包含連鎖の確認ステップを追加
- データ: P5 の p_pred に Fs-23=1, Fs-96=1 等を追加（他の段階も同様に確認）

### 問題1b: 検証スクリプトの T 特定がバグ

**現象**: L2-0, L2-5 が T=P2 と判定する。

**原因**: スクリプトが T を `depth 最大のパラダイム` として動的に算出している（reachability.py:25）。しかし T（真実パラダイム）は確定的にデータで与えられるものであり、推定すべきものではない。

```python
# 現在のバグコード
t_pid = max(paradigms, key=lambda pid: paradigms[pid].depth or 0)
```

**対処**: データの `truth_paradigm` フィールドを使用するように修正。データ側にも truth_paradigm を明示的に設定する。

### 付記: 用語「メインパス」の問題

パラダイム発見等で「メインパス」という用語を使用しているが不適切。特定のパスに特権的な位置づけを与えてしまう。実際にはたまたま思いついた一つのパスに過ぎず、「基準パス」程度の位置づけが正しい（それも必要があれば、という程度のもの）。理論文書の用語修正が必要。


## 問題2: neighbors はエンジンが動的計算する（手動設定は無視される）

### 現象

apply_v2_patch.py で JSON に neighbors を手動追加したが、`load_data` は JSON の neighbors を読み込まない。代わりに `compute_neighborhoods` が O* と Explained 集合から全自動で算出し、Paradigm オブジェクトの neighbors を上書きする。

### エンジンの計算ロジック（threshold.py:36-108）

```
P' が P の近傍 ⟺
  1. tension(O*, P') < tension(O*, P)  （strict <）
  2. Remaining(P', P) ⊂ Anomaly(P)    （真部分集合）
  3. Hasse図で直接後続（中間がない）
  4. Explained包含で冗長でない
```

### 計算結果と手動設計の差異

```
       計算結果            手動設計
P1  → [P2, S1]          [P2, S1]       一致
P2  → [S2]              [P3, S2]       P3が欠落
P3  → [P5]              [P4]           完全に異なる
P4  → [P5]              [P5]           一致
S1  → [P3, S2]          [P3]           S2が追加
S2  → [P3, P4]          [P4]           P3が追加
```

<!--
注: P2→P3 が計算結果に含まれないのは、Remaining(P3, P2)の条件を満たさないか、
HasseDiagramのフィルタで除外されているため。
P3→P5 が直接接続するのは、P3とP5のAnomaly集合の差が小さいため（P3のanomaly=3個のうち
多くがP5で解消される）。P4を経由しないのはP4のExplained集合がP3のExplainedを包含しないため。
これはdepth問題（問題1）と根は同じ。
-->

### 影響範囲

- 理論の「関係構造の構成」規則に neighbors の手動定義手順があるなら、それは不要
- パラダイムシフト経路が設計意図と異なる動作をする
- O* シフト連鎖が P1→S1→P3→P5 となり、P2, P4 をスキップする

### 対処の方向性

- 理論規則から neighbors 手動定義を削除し、「エンジンが O* から導出する」と明記
- ただし、計算結果が望ましいシフト経路を生成するかは p_pred の設計に依存する（問題1と連動）


## 問題3: Phase 1 と Phase 2 の循環依存

### 現象

v1 の Phase 2（質問構造設計）でゲート辺が設計されたが、Phase 1 の R(P) には反映されなかった。v2 の Phase 1 差し戻しで初めてゲート辺を R(P) に追加した。

### 原因

アルゴリズムの依存構造に暗黙の循環がある:

```
Phase 1: 記述素展開 → パラダイム発見 → 内部構造構成（p_pred, R(P)）
Phase 2: 質問構造設計（層構造、ゲート辺設計）
```

- R(P) のゲート辺を構成するには、Phase 2 の層構造情報が必要
- 層構造を設計するには、Phase 1 の記述素・パラダイムが必要

<!--
注: 05_質問構造設計.md のStep 3で「ゲート辺」が設計されているが、
これは04_内部構造構成.md のR(P)には書き戻されていない。
形式化（08_形式化.md）ではPhase 1のR(P)がそのまま使われ、
Phase 2で設計されたゲート辺は欠落した。
アルゴリズムの手順書にこの「書き戻し」ステップが存在しない。
-->

### 対処の方向性

Phase 1 と Phase 2 の分離を見直す。選択肢:

1. Phase 2 完了後に Phase 1 の R(P) を更新するステップを明示的に追加
2. R(P) 構成を Phase 2 に移動（層構造設計と同時にゲート辺を含むR(P)を構成）
3. Phase 1 では基本辺（Rules 1-3）のみ構成し、ゲート辺（Rule 5）は Phase 2 で追加と規則に明記


## 問題4: R(P) 設計が逆算でない

### 現象

v2 で R(P) に 14本（P1）追加したが、P3 の層1→層2 ゲート開放率は 0%。「辺の量」ではなく「辺の方向」が問題。

### 原因

現在の R(P) 設計は正方向:「この2つの記述素は概念的に関連する → 辺を張る」。
必要なのは逆算:「この質問をオープンしたい → effect 記述素 X に BFS で到達する辺が必要 → consistent/anomaly 集合から X への経路を設計」。

<!--
注: P3のR(P)は Fs-83, Fs-84, Fs-60, Fs-96, Fs-56 起点の辺を持つが、
層1の質問 q11(M-4), q13(M-1), q25(M-4), q27(Ft-20) のeffect記述素に
consistent/anomaly集合からBFSで到達できない。
P3のconsistent集合にはFs-14, Fs-31, Fs-60, Fs-61, Fs-84等が含まれるが、
これらからM-4, M-1, Ft-20への辺がR(P)にない。
Fs-84→M-4(w=0.6)はR(P)に存在するが、Fs-84がconsistent集合に入るかは
P3のp_pred次第。P3はFs-84に対してp_pred=1, O*でFs-84=1なのでconsistent。
→ Fs-84→M-4 で M-4 に到達可能なはず。
しかしゲート開放率が0%ということは、BFS到達の条件が別にある可能性。
エンジンのopen_questions条件を再確認する必要がある。
-->

### 対処の方向性

R(P) 構成規則に逆算手順を追加:

```
Step A: 各パラダイムの各層 n の質問をリストアップ
Step B: 各質問の effect 記述素を特定
Step C: consistent/anomaly 集合（層 n-1 まで回答後）から effect 記述素への BFS 経路を確認
Step D: 経路が存在しない場合、中間辺を追加（認知的正当性を検証）
```

<!--
注: このStep B→C→Dの手順は、Phase 2の層構造が確定した後でないと実行できない。
問題3（循環依存）と密接に関連する。
-->


## 問題5: L2-2 同化接続性の全面 NG

### 現象

全9近傍ペアで NG。到達可能ターゲットが 20-45個あるのに、カバー済みは 0-8個。

### 分析

L2-2 は「近傍遷移後に、新パラダイムで R(P) 到達可能なターゲットがアノマリー質問でカバーされているか」を検証する。

問題は、R(P) 到達可能ターゲットにはパラダイムの p_pred にすら含まれない記述素（p_pred=不定）が大量に含まれること。p_pred=不定の記述素はアノマリーにならないため、カバーする質問が存在しない。

<!--
注: L2-2の検証基準が「到達可能ターゲット全体のカバー」を要求しているなら、
p_pred=不定の記述素は原理的にカバー不可能（anomaly qualが成立しない）。
検証基準の妥当性を再検討する必要がある。
あるいは、p_predの網羅率を上げる（全到達可能ターゲットに予測を付与する）必要がある。
後者はp_pred数の爆発につながり、設計として非現実的かもしれない。
-->

### 対処の方向性

検証基準の妥当性を再検討。選択肢:

1. カバー対象を「p_pred が定義されている記述素」に限定
2. カバー対象を「anomaly 記述素」に限定
3. 現行基準を維持し、p_pred の網羅率を上げる


## まとめ: 反復では解決できない

問題1〜4は相互に連動している:

```
問題1 (depth/Explained) ←→ 問題2 (neighbors動的計算)
    ↑                           ↑
    p_pred設計                  p_pred設計
    ↓                           ↓
問題3 (Phase間循環依存) ←→ 問題4 (R(P)逆算設計)
```

共通の根本原因は **p_pred の設計に構造的制約が不足していること**、および **Phase 1 と Phase 2 の接続が暗黙的であること**。

データレベルの反復（v3, v4...）で個別のゲート開放率を改善することは可能だが、depth/neighbors/シフト経路の問題は理論レベルでの再設計なしには解決しない。

# P4 スキップ問題の分析

## 現象

turtle_soup.json の play_simulation 結果:

```
シフト履歴:
  Step 30: P1 -> P2
  Step 31: P2 -> P3
  Step 43: P3 -> P5   ← P4がスキップされる
最終パラダイム: P5
クリア: 不達成（オープン質問枯渇で停止、55問回答）
```

期待する経路: P1 → P2 → P3 → **P4** → P5

## 直接原因

シフト候補条件 `explained_o(O, P') > explained_o(O, P_current)` において、P4 の eo が P3 の eo を超えない。

### Step 43（P3→P5シフト時点）の eo

```
P3: eo=43 (current)  → 候補条件の基準
P4: eo=43             → P3と同値、43 > 43 は偽 → 候補にならない
P5: eo=44             → 唯一の候補
```

P4 は P3 と eo が同値のため、候補に入らず、P5 が唯一の候補として選択される。最小跳躍ロジック（candidates の中で min eo を選ぶ）は P4 が候補に入って初めて効果を発揮するため、この問題には効かない。

### P3 と P4 の eo 差分の原因

Step 42 完了後の O（|O|=43）に対する P3 と P4 の予測を比較:

```
両方正解:     42 項目
P3のみ正解:    1 項目  →  Fs-01: O=1, P3 pred=1(✓), P4 pred=0(✗, Conceivable内)
P4のみ正解:    0 項目
```

**Fs-01（レストランの存在）の 1 項目の差が全てを決めている。**

## 根本原因: P4 の Fs-01=0 予測

### Fs-01 の各パラダイムにおける状態

| パラダイム | pred | in_conceivable | O*=1 との一致 |
|-----------|------|---------------|-------------|
| P1 | 1 | Yes | ✓ |
| P2 | 1 | No（reconstruction追加） | ✓ |
| P3 | 1 | No（reconstruction追加） | ✓ |
| **P4** | **0** | **Yes** | **✗ ← 唯一の不一致** |
| P5 | 1 | Yes（前回セッションで修正済） | ✓ |

P4（極限状況での隠蔽）が Fs-01=0（レストランの存在を否定）を Conceivable 内予測として持っている。`reconstruct_ppred.py` は Conceivable 内の既存予測を上書きしない設計のため、この誤予測が維持された。

### なぜ reconstruct で修正されなかったか

`reconstruct_ppred.py` の設計原則:
```python
if d_id in ppred:
    skipped_existing += 1
    continue  # Conceivable内の既存予測は保持
```

surface_layer1 に Fs-01=1 が含まれていたが、P4 の Conceivable に Fs-01=0 が既に存在したためスキップされた。

## Fs-01 のジレンマ

P4 の Fs-01=0 は二重の役割を果たしている:

1. **シフト駆動**: P4 の唯一の anomaly（tension の源泉）。Fs-01=1 が O に入ると tension=1 > threshold=0 でシフト発動。
2. **eo ペナルティ**: P3 が Fs-01=1 を正しく予測するのに対し、P4 は pred=0 で不一致。eo に -1 の差が生じ、P4 が候補になれない。

**修正すると:**
- Fs-01=0 → 1 に変更: eo ペナルティは解消するが、P4 の anomaly が 0 になり tension が永久に 0。P4→P5 シフトが発生しなくなる。
- P4 の threshold は 0 なので、tension > 0 が発動条件。anomaly=0 では永久にシフトしない。

## P4 の anomaly 構造

```
P4 Conceivable (26項目):
  固有Conceivable（他のどのパラダイムにも属さない）: 14項目 → anomaly 0
  共有Conceivable:
    P4∩P1: 6項目, anomaly=['Fs-01']
    P4∩P2: 4項目, anomaly=[]
    P4∩P3: 8項目, anomaly=[]
    P4∩P5: 2項目, anomaly=['Fs-01']
    P4∩S1: 2項目, anomaly=[]
    P4∩S2: 1項目, anomaly=[]

threshold(P4) = |固有anomaly| + min_{P'} |共有anomaly(P4, P')| = 0 + 0 = 0
```

P4 の固有 Conceivable 14 項目は全て O* と一致（anomaly なし）。共有 anomaly は Fs-01 のみで、Fs-01 を共有しない P'（P2, P3, S1, S2）との min は 0。

## 影響範囲

1. **P4 は全遷移時点で候補にならない**: Step 30（P1→P2）、Step 31（P2→P3）、Step 43（P3→P5）の全てで P4 eo ≤ current eo:
   - Step 30: P4 eo=34, P1 eo=34 → 候補外
   - Step 31: P4 eo=35, P2 eo=35 → 候補外
   - Step 43: P4 eo=43, P3 eo=43 → 候補外

2. **O 内の全項目が P3/P4 両方で予測済み**: Step 42 の O（43項目）に対して、P3 にも P4 にも未予測の項目が 0。追加予測で P4 を引き上げる余地がない。

3. **bar_man.json には影響なし**: 別データセット。

## O* ベースのパラダイム状態（現在）

```
P1: |p_pred|=44, |conceivable|=38, eo(O*)=28, tension(O*)=10, threshold=0
P2: |p_pred|=49, |conceivable|=16, eo(O*)=40, tension(O*)=3,  threshold=0
P3: |p_pred|=68, |conceivable|=20, eo(O*)=58, tension(O*)=3,  threshold=0
P4: |p_pred|=81, |conceivable|=26, eo(O*)=74, tension(O*)=1,  threshold=0
P5: |p_pred|=90, |conceivable|=12, eo(O*)=83, tension(O*)=0,  threshold=—
```

eo(O*) の順序 P1 < P2 < P3 < P4 < P5 は達成されているが、**シミュレーション中の動的な eo は O* ではなくその時点の部分的な O で計算される**ため、Fs-01 の差がシミュレーション全体に影響する。

## 各シフト時点の詳細

### Step 30: P1 → P2

```
P1 eo=34 (current), tension=1 > threshold=0 → シフト発動
candidates: P2(35), P3(35), P5(35)  [全て > 34]
            P4(34) → 候補外 [34 > 34 は偽]
nearest (min eo=35): {P2, P3, P5}
→ alignment で P2 選択
```

### Step 31: P2 → P3

```
P2 eo=35 (current), tension=1 > threshold=0 → シフト発動
q100 の effect: Fs-05, Ft-03 → Ft-03 が O に入る
candidates: P3(36), P5(36)  [全て > 35]
            P4(35) → 候補外 [35 > 35 は偽]
nearest (min eo=36): {P3, P5}
→ alignment で P3 選択
```

### Step 43: P3 → P5

```
P3 eo=43 (current), tension=1 > threshold=0 → シフト発動
candidates: P5(44)  [44 > 43]
            P4(43) → 候補外 [43 > 43 は偽]
→ P5 のみ → P5 選択（P4 スキップ）
```

## 構造的な問題の整理

### 問題 1: P4 の Fs-01 予測

P4（極限状況での隠蔽）が「レストランの存在」を否定するのは物語上不自然。全パラダイムでレストランは存在する（問題文の前提）。これはサンプル分析の Conceivable 設計の問題と考えられる。

### 問題 2: P4 の anomaly が Fs-01 に依存

P4 の唯一の anomaly が Fs-01。修正すると anomaly=0 となり P4→P5 シフトの駆動力がなくなる。P4 には Fs-01 以外の narratively justified な anomaly が必要。

### 問題 3: P3 フェーズでの eo の余地がない

Step 42 の O 内全項目が P3/P4 両方で予測済み。非 Conceivable 予測の追加で P4 の eo を引き上げる余地がない。この問題は問題 1 の修正（Fs-01 の eo ペナルティ解消）で解決可能。

## 理論の問題と適用の問題の切り分け

### 理論の問題

#### 1. 最小跳躍ロジック（engine.py に追加済み、理論文書に未反映）

現行理論（パラダイムシフトの機構.md）:

```
候補 = { P' | explained_o(O, P') > explained_o(O, P_current) }
P_new = argmax_{P' ∈ 候補} alignment(H, P')
```

追加したロジック（engine.py）:

```
候補の中で explained_o が最小のグループに限定 → その中で argmax alignment
```

**導入動機**: P5 の Fs-01 修正後、P5 eo が常に P4+1 のため P3→P5 ジャンプが発生。最小跳躍で段階的深化を強制。

**検討事項**: 適切にデータが設計されていれば、alignment だけで段階的選択が実現されるはず（H が不十分な段階では遠いパラダイムの alignment は低くなる）。最小跳躍が必要になったのは、データ設計の不備に対するワークアラウンドだった可能性がある。一方で、安全弁として理論に組み込む価値があるかもしれない。

**判断**: 現時点では保留。サンプル再構築後に最小跳躍なしで正しく動作するか検証し、必要性を再評価する。

#### 2. 全メインパラダイムで threshold=0

threshold の計算結果:

```
threshold(P) = |固有想起アノマリー| + min_{P'} |共有想起アノマリー(P, P')|

P1: threshold=0, P2: threshold=0, P3: threshold=0, P4: threshold=0
```

全パラダイムで threshold=0 なのは、共有アノマリーが 0 の相手パラダイムが必ず存在するため。threshold=0 は「anomaly 1 つで即シフト」を意味し、非常に敏感なシステムになる。

**検討事項**: threshold 計算式自体の見直しが必要か、threshold=0 でも正しく機能するデータ設計を目指すか。

**判断**: threshold の計算式は理論的に導出されたもの。0 という結果はデータ構造の帰結。サンプル再構築で Conceivable の固有/共有構造を見直した結果を見て再評価する。

### 適用（サンプル設計）の問題

#### 1. P4 の Fs-01=0 — 問題文の前提事実を否定（主因）

Fs-01（レストランの存在）は問題文の前提事実であり、全パラダイムで一致すべき。P4（極限状況での隠蔽）がこれを否定するのは物語上不自然。サンプル分析時の Conceivable 設計の誤り。

#### 2. P4 の anomaly 不足

P4 の Conceivable 内 anomaly が Fs-01 の 1 つのみ。P4 の世界観が「間違うべき」項目が設計されていない。例えば P4 は真相（人肉）を知らないので、それに関する誤った予測を持つべき。

#### 3. reconstruct_ppred の制約はサンプルの帰結

reconstruct_ppred が Conceivable 内予測を変更しない設計は正しい。Conceivable はサンプル分析から決まるもので、reconstruction はその外側に論理的予測を追加するのみ。問題はサンプル自体にある。

### 対応方針

サンプル（samples/001_ウミガメのスープ/）のパラダイム定義を見直し、P4 の Conceivable を再設計する。その結果を POC データに反映する。

理論の問題（最小跳躍、threshold=0）は、サンプル再構築後の検証結果を見て再評価する。

## 前回セッションからの変更記録

### engine.py
1. tension check: `>=` → `>` に修正（理論仕様と整合）
2. 最小跳躍ロジック追加（candidates 中の min eo グループのみ選択）
3. `>=` fallback は追加後に削除（振動問題のため）

### shift_path.py
1. 最小跳躍ロジック追加（engine.py と整合）

### turtle_soup.json
1. P5 の Fs-01: pred=0 → 1 に修正（前回セッション）
2. P3 に Ft-03=1, Ft-09=1, Ft-11=1 を p_pred に追加（前回セッション）

### reconstruct_ppred.py
- 前回セッションで作成、実行済み。削除はまだ。

# anomaly発掘検証と対応方針

## 検証概要

`anomaly_discovery.py` で2つの検証を実施。

**anomaly質問の定義**: effectにP_initの予測と矛盾する(d, v)を含む質問。

## 検証結果

### Part 1: 初期オープンanomaly汚染

| データセット | 初期オープン数 | うちanomaly | 汚染率 |
|---|---|---|---|
| turtle_soup | 33 | 4 (q63, q64, q65, q100) | 12% |
| bar_man | 17 | 8 (q41, q56〜q62) | 47% |

**原因**: init_questionsの条件が「effectの(d,v)が1つでもP_initの予測と一致すればオープン」のため、effectが複数ある質問で一部がanomalyでも通過する。

### Part 2: 同化連鎖による発掘到達性

| データセット | anomaly総数 | 発掘可能 | 発掘不可 |
|---|---|---|---|
| turtle_soup | 29 | 28 | 1 (q90) |
| bar_man | 47 | 31 | 16 |

**原因**: safe質問の同化→H伝播の経路がanomaly質問のeffect記述素に到達しないケースがある。

## 対応

### Part 1: init_questionsロジック修正（実施済み）

修正前:
```
init_questions(P_init) = { q | ∃(d, v) ∈ effect(q) : P_init(d) = v }
```

修正後:
```
init_questions(P_init) = { q | ∃(d, v) ∈ effect(q) : P_init(d) = v
                             ∧ ¬∃(d', v') ∈ effect(q) : P_init(d') ≠ v' }
```

理論的解釈: P_initの視点では、自分の予測と矛盾する側面を持つ質問はそもそも発想として浮かばない。

修正後の検証: 両データセットでPart 1 OK。

### Part 2: 理論アルゴリズムの改善

#### 問題の本質

現在のS1/opening_reachは**パラダイム単位の静的分析**であり、各P_iの固有記述素からR(P_i)の推移閉包で到達可能な記述素を見ている。一方、実際のゲーム進行は**P_initからの動的な連鎖**であり、以下の点で静的分析とギャップがある:

- opening_reachでOK（静的に到達可能）でも、ゲーム進行の順序制約で実際には発掘されないケースがある
- パラダイムシフト後の同化で到達するパスは、opening_reachの各P_i独立分析では捉えきれない

#### S1アルゴリズムの改善

S1のStep 5（再検証）を拡張:

- **Step 5a**: opening_reach による静的到達性の検証（既存）
- **Step 5b**: anomaly_discovery による動的発掘連鎖の検証（新規）

Step 5bでNGの場合、新しい不足類型として**類型D（発掘連鎖の断絶）**を追加。静的には到達可能だが、ゲーム進行の順序制約で実際に発掘されないケース。

#### 新規則: 発掘連鎖到達性

「anomaly到達性充足」（静的）を補完する動的な規則。P_initのsafe質問群からの同化連鎖で全anomaly質問が発掘可能であること。

→ `theory/supplementary/rules/発掘連鎖到達性.md` として定式化。

#### データ側の対応方針

relationsやeffectは内容から自然に見出されるものなので、恣意的な修正ではなく:

- **空間生成時（E1/E2）**: anomaly質問への到達経路を意識し、中間的な記述素の合成や関係の設計で連鎖を確保する
- **質問追加時（S1/Q2）**: 新規anomaly質問がsafe質問からの同化連鎖で発掘可能かを確認する
- **検証**: anomaly_discovery.py をデータ作成後のチェックツールとして使う

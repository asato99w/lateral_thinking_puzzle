# v2 検証で発見された問題の整理

サンプル005（禁じられた地下室）の v1→v2 反復で発見された問題を整理する。
元のノート（同日付_禁じられた地下室v2検証で発見された構造的問題.md）は初期分析時のもので、問題の切り分けが不正確だった。本ノートで修正する。

## 問題1a: 基準パス上の Explained 包含連鎖が成立していない

**現象**: `compute_depths`（threshold.py）が算出する depth が想定と異なる。

```
計算結果:  P1=0, P2=1, P3=0, P4=0, P5=1
想定:      P1 < P2 < P3 < P4 < P5
```

**原因**: P5 の p_pred に Fs-23, Fs-96 等の表面事実が含まれていない。

```
          P1_pred   P5_pred   O*
Fs-23       1       None       1   ← P5に予測がない
Fs-96       1       None       1   ← P5に予測がない
```

Explained(P) = {d | P_pred(d) == O*(d)} で、P5 に予測がない記述素は Explained(P5) に入らない。
P1 はこれらを正しく予測するため Explained(P1) に含まれる。
→ Explained(P1) ⊄ Explained(P5) → 包含チェーン断絶。

**性質**: p_pred 設計時の単純な漏れ。基準パス上で包含連鎖が成立するかは機械的にチェックできる。反復的対応が必要な問題ではない。

<!--
具体的には、基準パス P1→P2→P3→P4→P5 の各段階で
Explained(P_i) ⊂ Explained(P_{i+1}) を確認すればよい。
不成立の場合、P_{i+1} の p_pred に不足している記述素を追加する。
アルゴリズム Phase 1（内部構造構成）の手順にこのチェックを追加すべき。
-->

**対処**:
- アルゴリズム: Phase 1 の p_pred 設計手順に包含連鎖の確認ステップを追加
- データ: P5 の p_pred に Fs-23=1, Fs-96=1 等を追加（他の段階も同様に確認）


## 問題1b: 検証スクリプトの T 特定がバグ

**現象**: L2-0, L2-5 が T=P2 と判定する。

**原因**: T（真実パラダイム）は確定的にデータで与えられるもの。スクリプトが depth 最大のパラダイムとして動的に推定しているのは単純なバグ。

```python
# reachability.py:25 — バグ
t_pid = max(paradigms, key=lambda pid: paradigms[pid].depth or 0)
```

**対処**: データの `truth_paradigm` フィールドを使用するよう修正。データ側にも truth_paradigm を明示的に設定する。


## 付記: 用語「メインパス」の問題

パラダイム発見等で「メインパス」という用語を使用しているが不適切。特定のパスに特権的な位置づけを与えてしまう。実際にはたまたま思いついた一つのパスに過ぎず、「基準パス」程度の位置づけが正しい（それも必要があれば、という程度）。理論文書の用語修正が必要。


## 問題2: アルゴリズムにない手順の独自作成（neighbors パッチ）

**現象**: パッチスクリプト（apply_v2_patch.py）で JSON に neighbors を手動追加したが、`load_data` は JSON の neighbors を読み込まない。`compute_neighborhoods`（threshold.py）が O* と Explained 集合から動的に算出する。手動追加は無視された。

**なぜこの行動に至ったか**:

1. JSON に neighbors が空であることを確認した
2. アルゴリズムに neighbors の具体的な構成手順がなかった
3. エンジンのデータフロー（load_data → compute_neighborhoods）を追わず、JSON に直接書き込めば反映されると判断した
4. アルゴリズムの原則（neighbors は Explained 集合と tension から導出される）を確認せず、独自に手動設計した

根本的には、アルゴリズムに手順として存在しないことを、アルゴリズムの原則に立ち返らずに独自判断で実行した。

**計算結果と手動設計の差異**:
```
       計算結果            手動設計
P1  → [P2, S1]          [P2, S1]       一致
P2  → [S2]              [P3, S2]       P3が欠落
P3  → [P5]              [P4]           完全に異なる
P4  → [P5]              [P5]           一致
S1  → [P3, S2]          [P3]           S2が追加
S2  → [P3, P4]          [P4]           P3が追加
```

<!--
P3→P5 が直接接続する（P4 を経由しない）のは、問題1a（Explained 包含連鎖の断絶）と根が同じ。
包含連鎖が修正されれば、compute_neighborhoods の結果も変わる可能性がある。

JSON に neighbors フィールドが混入した経緯も要確認（元の git 管理下のデータには存在しなかった可能性）。
-->

**対処**: neighbors はエンジンが p_pred と O* から導出するものであり、手動設計の対象ではない。アルゴリズムに手順がない操作を行う場合は、まずアルゴリズムの原則に立ち返り、その操作が原則と整合するか確認する。


## 問題3: Phase 間の接続手順の見落とし

v1 の Phase 2（質問構造設計）でゲート辺が設計されたが、Phase 1 の R(P) には反映されなかった。

**調査結果**: アルゴリズムには Phase 間の接続手順が明記されていた。

- 統合アルゴリズム Step 1-3: 「ゲート辺は Phase 2 の結果を受けて追加される」
- 統合アルゴリズム Step 2-3: 「ゲート辺は R(P) に追加する」
- 統合ルール（質問構造設計）Step 3: 「ゲート辺を設計する。ゲート辺は R(P) に追加する」

「手順の欠落」ではなく、既存の手順を実行者が見落とした。アルゴリズムの問題ではなく実行の問題。

<!--
05_質問構造設計.md の Step 3 で「ゲート辺」が設計されているが、
04_内部構造構成.md の R(P) には書き戻されていない。
形式化（08_形式化.md）では Phase 1 の R(P) がそのまま使われ、
Phase 2 で設計されたゲート辺は欠落した。

調査で確認したファイル:
- theory/integration/algorithms/統合アルゴリズム.md
- theory/integration/rules/質問構造設計.md
-->


## 問題4: R(P) 逆算手順の見落とし

v2 で R(P) に辺を追加したが、P3 の層1→層2 ゲート開放率は 0%。「辺の量」ではなく「辺の方向」が問題。

実行者は正方向（概念的関連性 → 辺を張る）で設計したが、必要なのは逆算（質問オープンに必要な到達パスから辺を決める）。

**調査結果**: アルゴリズムには R(P) の逆算手順が明記されていた。

- 個別ルール（関係構造の構成）Rule 5: 「設計の方向: ゲート辺は質問構造設計（アノマリーからの逆算）の結果として必要性が判明し、R(P) に追加される」
- 個別アルゴリズム（質問構造設計）Step 2: 「認知的到達経路の逆算」の詳細手順あり
- 個別アルゴリズム（質問構造設計）Step 3: 層構造への配置とゲート辺設計
- 個別アルゴリズム（質問構造設計）Step 4: 素材不足の検出（中間記述素やゲート辺の不足検出）

問題3と同様、「手順の不足」ではなく、既存の手順を実行者が見落とした。アルゴリズムは4階層（統合アルゴリズム・統合ルール・個別アルゴリズム・個別ルール）にわたって R(P) 構成手順を具体的に規定していた。

<!--
P3 の R(P) に Fs-84→M-4(w=0.6) が存在し、Fs-84 は consistent 集合に入るはずだが、
ゲート開放率が 0% になっている。エンジンの open_questions 条件の詳細確認が未完了。

調査で確認したファイル:
- theory/paradigm/internal/rules/関係構造の構成.md（Rule 5: ゲート辺）
- theory/question/algorithms/質問構造設計.md（Step 2: 逆算手順、Step 3: ゲート辺設計）
- theory/paradigm/internal/algorithms/A_内部構造構成.md（Step 4: R(P) 構成）
-->


## 問題5: L2-2 同化接続性の全面 NG

全9近傍ペアで NG。R(P) 到達可能ターゲットに p_pred=不定の記述素が大量に含まれ、これらはアノマリーにならないためカバー不可能。

問題1〜4の下流にあたる。包含連鎖（問題1a）の修正で neighbors が変わり、R(P) 構成（問題3・4）の改善で到達可能ターゲットも変わるため、上流の問題を解決した後に改めて判断する。検証基準自体の妥当性の問題である可能性も残るが、現時点では保留。


## 振り返り: アルゴリズムと適用の関係

問題2の議論から、サンプル生成におけるアルゴリズムと実行者の関係について構造的な課題が明らかになった。

### 戦略・作戦・戦術の枠組み

アルゴリズムと実行者の関係は、軍事の三階層（戦略 > 作戦 > 戦術）で整理できる。

- **戦略 + 作戦** = アルゴリズムが規定する範囲。大方針と具体的手順の両方を含む
- **戦術** = 実行者に残される裁量。最下位レベルであり、自ずと限定的

アルゴリズムが上位二層を規定するため、誰が実行しても大まかな構成は同じ結果になる（再現性）。実行者の裁量は戦術レベルに限られ、多少の品質差は出るが構造は変わらない。

<!--
憲法と法律の関係にも似る。各レベルには裁量があるが、上位の枠組みの中で行使する。
裁量を持つこと自体が問題なのではなく、上位原則に整合しない判断が問題。
-->

### 再現性を粒度の基準とする

アルゴリズムに含めるべき手順と、実行者の裁量に委ねてよい判断の線引きは、**再現性**を基準にできる。

- 「この手順は誰がやっても同等の結果が出るか？」→ Yes ならアルゴリズムに含める
- 包含連鎖のチェック、R(P) 構成の具体的手順などは機械的に実行可能であり、アルゴリズム（作戦レベル）が規定すべき

### 今回の問題の両面性

1. **アルゴリズム側（限定的）**: 包含連鎖チェックの明示的なステップは不足していた（問題1a）。ただし R(P) 構成・ゲート辺設計・逆算手順については4階層にわたって具体的に規定されていた（問題3・4の調査結果）
2. **実行者側（主要因）**: アルゴリズムに既に規定されている手順（Phase間の接続、R(P) 逆算）を見落とした（問題3・4）。また、アルゴリズムの原則に立ち返らず独自に作戦レベルの判断を行った（neighbors 手動設計、問題2）

### 対処

- **アルゴリズム（限定的修正）**: 包含連鎖チェックの明示的なステップを Phase 1 手順に追加する。R(P) 構成・ゲート辺・逆算手順は既に十分具体的に規定されているため大幅な改善は不要
- **スキル（sample-generate）**: アルゴリズムとの整合関係を明記する。実行者の裁量は戦術レベルに限定されること、アルゴリズムに手順がない操作を行う場合はアルゴリズムの原則に立ち返ることを明示する。特に、アルゴリズムの4階層（統合アルゴリズム・統合ルール・個別アルゴリズム・個別ルール）を各 Phase で確実に参照するよう指示する
- ~~**アルゴリズムの具体性の調査**~~: 完了。R(P) 構成手順は4階層にわたり具体的に規定されていた（問題3・4の調査結果参照）。問題の主因はアルゴリズムの不足ではなく実行者の見落とし
- **アルゴリズム作成・改善のスキル化**: sample-generate だけでなく、アルゴリズム自体の作成や改善もスキルとして整備することを検討する

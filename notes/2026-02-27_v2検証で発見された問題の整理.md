# v2 検証で発見された問題の整理

サンプル005（禁じられた地下室）の v1→v2 反復で発見された問題を整理する。
元のノート（同日付_禁じられた地下室v2検証で発見された構造的問題.md）は初期分析時のもので、問題の切り分けが不正確だった。本ノートで修正する。

## 問題1a: 基準パス上の Explained 包含連鎖が成立していない

**現象**: `compute_depths`（threshold.py）が算出する depth が想定と異なる。

```
計算結果:  P1=0, P2=1, P3=0, P4=0, P5=1
想定:      P1 < P2 < P3 < P4 < P5
```

**原因**: P5 の p_pred に Fs-23, Fs-96 等の表面事実が含まれていない。

```
          P1_pred   P5_pred   O*
Fs-23       1       None       1   ← P5に予測がない
Fs-96       1       None       1   ← P5に予測がない
```

Explained(P) = {d | P_pred(d) == O*(d)} で、P5 に予測がない記述素は Explained(P5) に入らない。
P1 はこれらを正しく予測するため Explained(P1) に含まれる。
→ Explained(P1) ⊄ Explained(P5) → 包含チェーン断絶。

**性質**: p_pred 設計時の単純な漏れ。基準パス上で包含連鎖が成立するかは機械的にチェックできる。反復的対応が必要な問題ではない。

<!--
具体的には、基準パス P1→P2→P3→P4→P5 の各段階で
Explained(P_i) ⊂ Explained(P_{i+1}) を確認すればよい。
不成立の場合、P_{i+1} の p_pred に不足している記述素を追加する。
アルゴリズム Phase 1（内部構造構成）の手順にこのチェックを追加すべき。
-->

**対処**:
- アルゴリズム: Phase 1 の p_pred 設計手順に包含連鎖の確認ステップを追加
- データ: P5 の p_pred に Fs-23=1, Fs-96=1 等を追加（他の段階も同様に確認）


## 問題1b: 検証スクリプトの T 特定がバグ

**現象**: L2-0, L2-5 が T=P2 と判定する。

**原因**: T（真実パラダイム）は確定的にデータで与えられるもの。スクリプトが depth 最大のパラダイムとして動的に推定しているのは単純なバグ。

```python
# reachability.py:25 — バグ
t_pid = max(paradigms, key=lambda pid: paradigms[pid].depth or 0)
```

**対処**: データの `truth_paradigm` フィールドを使用するよう修正。データ側にも truth_paradigm を明示的に設定する。


## 付記: 用語「メインパス」の問題

パラダイム発見等で「メインパス」という用語を使用しているが不適切。特定のパスに特権的な位置づけを与えてしまう。実際にはたまたま思いついた一つのパスに過ぎず、「基準パス」程度の位置づけが正しい（それも必要があれば、という程度）。理論文書の用語修正が必要。


## 問題2: アルゴリズムにない手順の独自作成（neighbors パッチ）

**現象**: パッチスクリプト（apply_v2_patch.py）で JSON に neighbors を手動追加したが、`load_data` は JSON の neighbors を読み込まない。`compute_neighborhoods`（threshold.py）が O* と Explained 集合から動的に算出する。手動追加は無視された。

**なぜこの行動に至ったか**:

1. JSON に neighbors が空であることを確認した
2. アルゴリズムに neighbors の具体的な構成手順がなかった
3. エンジンのデータフロー（load_data → compute_neighborhoods）を追わず、JSON に直接書き込めば反映されると判断した
4. アルゴリズムの原則（neighbors は Explained 集合と tension から導出される）を確認せず、独自に手動設計した

根本的には、アルゴリズムに手順として存在しないことを、アルゴリズムの原則に立ち返らずに独自判断で実行した。

**計算結果と手動設計の差異**:
```
       計算結果            手動設計
P1  → [P2, S1]          [P2, S1]       一致
P2  → [S2]              [P3, S2]       P3が欠落
P3  → [P5]              [P4]           完全に異なる
P4  → [P5]              [P5]           一致
S1  → [P3, S2]          [P3]           S2が追加
S2  → [P3, P4]          [P4]           P3が追加
```

<!--
P3→P5 が直接接続する（P4 を経由しない）のは、問題1a（Explained 包含連鎖の断絶）と根が同じ。
包含連鎖が修正されれば、compute_neighborhoods の結果も変わる可能性がある。

JSON に neighbors フィールドが混入した経緯も要確認（元の git 管理下のデータには存在しなかった可能性）。
-->

**対処**: neighbors はエンジンが p_pred と O* から導出するものであり、手動設計の対象ではない。アルゴリズムに手順がない操作を行う場合は、まずアルゴリズムの原則に立ち返り、その操作が原則と整合するか確認する。


## 問題3: Phase 1 と Phase 2 の循環依存

<!-- 元ノートから転記。議論による修正は未実施。 -->

v1 の Phase 2（質問構造設計）でゲート辺が設計されたが、Phase 1 の R(P) には反映されなかった。

アルゴリズムの依存構造に暗黙の循環がある:
- R(P) のゲート辺構成には Phase 2 の層構造情報が必要
- 層構造の設計には Phase 1 の記述素・パラダイムが必要

<!--
05_質問構造設計.md の Step 3 で「ゲート辺」が設計されているが、
04_内部構造構成.md の R(P) には書き戻されていない。
形式化（08_形式化.md）では Phase 1 の R(P) がそのまま使われ、
Phase 2 で設計されたゲート辺は欠落した。
アルゴリズムの手順書にこの「書き戻し」ステップが存在しない。
-->


## 問題4: R(P) 設計が逆算でない

<!-- 元ノートから転記。議論による修正は未実施。 -->

v2 で R(P) に辺を追加したが、P3 の層1→層2 ゲート開放率は 0%。「辺の量」ではなく「辺の方向」が問題。

現在の設計は正方向（概念的関連性 → 辺を張る）。必要なのは逆算（質問オープンに必要な到達パスから辺を決める）。

<!--
P3 の R(P) に Fs-84→M-4(w=0.6) が存在し、Fs-84 は consistent 集合に入るはずだが、
ゲート開放率が 0% になっている。エンジンの open_questions 条件の詳細確認が未完了。
-->


## 問題5: L2-2 同化接続性の全面 NG

<!-- 元ノートから転記。議論による修正は未実施。 -->

全9近傍ペアで NG。R(P) 到達可能ターゲットに p_pred=不定の記述素が大量に含まれ、これらはアノマリーにならないためカバー不可能。検証基準の妥当性を再検討する必要がある可能性。


## 振り返り: アルゴリズムと適用の関係

問題2の議論から、サンプル生成におけるアルゴリズムと実行者の関係について構造的な課題が明らかになった。

### 戦略・作戦・戦術の枠組み

アルゴリズムと実行者の関係は、軍事の三階層（戦略 > 作戦 > 戦術）で整理できる。

- **戦略 + 作戦** = アルゴリズムが規定する範囲。大方針と具体的手順の両方を含む
- **戦術** = 実行者に残される裁量。最下位レベルであり、自ずと限定的

アルゴリズムが上位二層を規定するため、誰が実行しても大まかな構成は同じ結果になる（再現性）。実行者の裁量は戦術レベルに限られ、多少の品質差は出るが構造は変わらない。

<!--
憲法と法律の関係にも似る。各レベルには裁量があるが、上位の枠組みの中で行使する。
裁量を持つこと自体が問題なのではなく、上位原則に整合しない判断が問題。
-->

### 再現性を粒度の基準とする

アルゴリズムに含めるべき手順と、実行者の裁量に委ねてよい判断の線引きは、**再現性**を基準にできる。

- 「この手順は誰がやっても同等の結果が出るか？」→ Yes ならアルゴリズムに含める
- 包含連鎖のチェック、R(P) 構成の具体的手順などは機械的に実行可能であり、アルゴリズム（作戦レベル）が規定すべき

### 今回の問題の両面性

1. **アルゴリズム側**: 作戦レベルの手順が不足していた（包含連鎖チェック、R(P) 構成の具体手順など）。本来再現可能な手順が欠けていたため、実行者の裁量に丸投げされた
2. **実行者側**: 戦術レベルを超えた判断をした（neighbors の手動設計など）。アルゴリズムの原則に立ち返らず、独自に作戦レベルの判断を行った

### 対処

- **アルゴリズム**: 作戦レベルの手順を補充する。再現性の基準で、アルゴリズムに含めるべき手順を特定し追加する。また、アルゴリズム自体の見直しフェーズを設ける
- **スキル（sample-generate）**: アルゴリズムとの整合関係を明記する。実行者の裁量は戦術レベルに限定されること、アルゴリズムに手順がない操作を行う場合はアルゴリズムの原則に立ち返ることを明示する

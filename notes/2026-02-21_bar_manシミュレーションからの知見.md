# bar_man シミュレーションからの知見

## 背景

bar_man.json（バーの男）を 06_形式化.md から生成し、POC エンジンでシミュレーションしたところ、ゲームが進行停止した。ウミガメのスープ（turtle_soup.json）で発見された「アノマリー開放不可能性」と同型の問題に加え、新たに 2 つの構造的課題が判明した。

以下、3 つのテーマに整理する。

---

## テーマ 1: tension 蓄積量とシフト閾値の不整合

### 発見

偶然の開き（D⁺ + D⁻ 混在質問）を bar_man データに正しく設計しても、1 回の偶然の開きで生じる anomaly は 1 件（1 つの D⁻ 記述素の観測）。一方、エンジンの `TENSION_THRESHOLD = 2` は `tension > 2`（= 3 件以上の anomaly）を要求する。

結果: 偶然の開きを 1 つ踏んだだけではシフトが発動しない。

### 分析

- **ウミガメのスープ**: D(P1) が大きく質問数も多いため、偶然の開きを 3 回以上踏む機会がある。閾値 2 でも「いつか超える」ことが期待できた。
- **バーの男**: パラダイムあたりの記述素が少なく（D(P1) ≈ 10 前後）、偶然の開きの設計余地が限られる。閾値 2 では偶然の開きを 3 回踏む必要があり、現実的に困難。

### アルゴリズムへの示唆

偶然の開きの質問数と tension_threshold の関係に整合性条件が必要。

```
必要条件: |偶然の開き質問(P)| ≥ tension_threshold + 1
```

各パラダイム P について、D⁺(P) × D⁻(P) を含む質問（偶然の開き候補）の数を数え、threshold を超えるだけの anomaly 源があるか検証すべき。

### 評価スクリプトへの示唆

```
検証項目: 各パラダイム P について
  - 偶然の開き候補の質問数
  - 最大到達可能 tension（全偶然の開きを踏んだ場合）
  - max_tension > tension_threshold であること
```

---

## テーマ 2: alignment 関数によるシフト先選択の制御不能

### 発見

パラダイムシフト時、エンジンは全候補パラダイムの `alignment(O, P)` を比較し、最大のものに遷移する。しかし、真相パラダイム P_T は全ての真の記述素を D⁺ に含むため、観測 O が増えるほど `alignment(O, P_T)` が他のどのパラダイムよりも高くなる。

結果: P1 → P4（真相）に直接ジャンプし、中間パラダイム P2, P3 を経由しない。

### 分析

alignment の定義:

```
alignment(O, P) = |{d ∈ D(P) ∩ O : prediction(d) == O[d]}| / |D(P) ∩ O|
```

P_T は全ての d について `prediction(d) == truth(d)` なので、O が真の観測値である限り alignment(O, P_T) = 1.0。中間パラダイムは一部に不一致（意図的な「まだ見えていない部分」）を含むため、alignment < 1.0 になる。

これは理論設計上の根本的な問題:
- **パラダイムシフトの漸進性**（P1→P2→P3→...→P_T）は理論の中核的な仕組み
- **alignment による選択**はこの漸進性を保証しない
- 現在のアルゴリズムでは、十分な観測がある状態でシフトが起きると、常に P_T が「最も説明力が高い」として選ばれる

### アルゴリズムへの示唆

シフト先選択のアルゴリズムに「漸進性制約」が必要。候補を以下のいずれかで制限する:

1. **遷移グラフ制約**: 各パラダイムから遷移可能な次のパラダイムを明示的に定義する（今回 `shift_candidates` として応急実装したもの）
2. **新規説明力**: alignment の絶対値ではなく、「現パラダイムでは説明できなかった anomaly をどれだけ説明するか」で選択する
3. **D(P) のカバレッジ制約**: O と重なる部分が少なすぎるパラダイムを除外する（「まだ出番でない」パラダイムの早期選出を防ぐ）

### 評価スクリプトへの示唆

```
検証項目:
  - 全パラダイム P について alignment(O*, P) を計算（O* = 全真値観測）
  - alignment(O*, P_T) が常に最大かどうか
  - 中間パラダイムが選ばれ得る条件（部分観測）の存在確認
  - 遷移グラフの連結性: P_init → ... → P_T のパスが存在するか
```

---

## テーマ 3: 同化による質問開放の停滞

### 発見

パラダイムシフト後（P1→P2）、新パラダイムでの同化が行われるが、P2 の質問がオープンにならない。原因: P2 の R(P) 関係のソース記述素がまだ観測されていない場合、同化が発火せず、H が動かない。

結果: シフトしても新しい質問が開かず、ゲームが停滞する。

### 分析

同化の流れ:

```
1. O に含まれる記述素 d のうち、P2 の D(P2) に属するものを探す
2. P2.prediction(d) == O[d] なら、d を起点に R(P2) の関係を辿る
3. ターゲット記述素 t の H[t] を P2 の予測方向に動かす
```

問題: P1 時代に観測された記述素が P2 の D(P2) にも含まれ、かつ P2 でも一致するときのみ同化が発火する。P1 と P2 の D 空間の重なりが小さいと、同化の起点がなくなる。

さらに R(P) のターゲット記述素の H が動いても、その値が open 条件（H[d] ≈ v）に近づくかはパラダイムの D⁺/D⁻ 設計に依存する。

### アルゴリズムへの示唆

パラダイム間の「同化接続性」を事前に検証する仕組みが必要。

```
同化接続性条件: パラダイム P_i → P_{i+1} シフト時に、
  ∃d ∈ O ∩ D(P_{i+1}) : prediction_{i+1}(d) == O[d]
  かつ R(P_{i+1}) で d から到達可能な未回答質問が存在する
```

これは質問生成アルゴリズム（Q1 等）や内部構造構成アルゴリズム（04_内部構造分析）で考慮すべき制約。

### 評価スクリプトへの示唆

```
検証項目:
  - 各シフト P_i → P_{i+1} について:
    - O(P_i 終了時) ∩ D(P_{i+1}) の大きさ
    - その中で prediction_{i+1}(d) == O[d] となる d の有無
    - R(P_{i+1}) の到達可能性（ソースから質問の effect 記述素への経路）
  - 全シフトについてこの接続性が成立することを確認
```

---

## まとめ

| テーマ | 問題の本質 | 改善先 |
|--------|-----------|--------|
| 1. tension 閾値 | 偶然の開き数と閾値の量的不整合 | データ検証、tension_threshold の自動算出 |
| 2. alignment 選択 | 真相パラダイムが常に最高 alignment | シフト先選択アルゴリズムの再設計 |
| 3. 同化接続性 | シフト後に同化の起点がない | 内部構造設計・質問生成アルゴリズムの制約追加 |

3 つとも「エンジンのバグ」ではなく、理論・アルゴリズムの設計上の制約条件として捉えるべき。エンジンを場当たり的に修正するのではなく、これらの条件を事前に検証する評価スクリプトに組み込むことが正しいアプローチである。

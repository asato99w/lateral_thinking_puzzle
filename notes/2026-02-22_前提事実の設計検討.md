# 前提事実（prerequisites）

## 動機

現在、質問のオープン判定は effect 内の記述素の H 値のみで決まる：

```
open(q) ⟺ ∃(d, v) ∈ effect(q): |H[d] - v| < ε
```

この仕組みでは「この質問を聞くには何を知っている必要があるか」という論理的な前提条件を表現できない。質問間に「Xが確定しないとYを聞くこと自体が成立しない」という依存関係がある場合、それを明示する手段がない。

## 定義

**前提事実** prerequisite(q) とは、質問 q が利用可能になるために確定済み（O に含まれる）であることを要求する記述素の集合。

```
prerequisite(q) = {d₁, d₂, ...}
判定: ∀d ∈ prerequisite(q): d ∈ O
```

ゲームの correct_answer は固定されているため、記述素が O に入る際の値は一意に定まる。値を別途指定する必要はない。

## JSON 表現

```json
{
  "id": "q42",
  "text": "...",
  "prerequisites": ["Fs-26"],
  "ans_yes": [...], "ans_no": [...], "ans_irrelevant": [...],
  "correct_answer": "yes"
}
```

前提事実がない質問は `"prerequisites": []` またはフィールド省略。

## init_questions への影響

現行：

```
init(q, P_init) ⟺ hasMatch(effect(q), P_init) ∧ ¬hasConflict(effect(q), P_init)
```

追加条件：

```
init(q, P_init) ⟺ 現行条件 ∧ ∀d ∈ prerequisite(q): d ∈ O_init
```

初期の O には Ps 値のみが含まれる。prerequisite に Ps 以外の記述素を含む質問は初期オープンから除外される。

## open_questions への影響

現行：

```
open(q, state) ⟺ q ∉ answered ∧ ∃(d, v) ∈ effect(q): |H[d] - v| < ε
```

追加条件：

```
open(q, state) ⟺ 現行条件 ∧ ∀d ∈ prerequisite(q): d ∈ O
```

前提の記述素が確定していない質問は、effect の H 条件が満たされても開かない。

## 偶然の開きとの関係

前提事実と偶然の開きは補完関係にある：

- **偶然の開き**: effect 内の開放記述素の H 値で質問を開かせる仕組み
- **前提事実**: 質問の論理的前提を O の確定状態で制御する仕組み

両者は AND 条件で組み合わさる。

## 判定基準のバランス

何を前提事実とするかの判定基準には、緩すぎと厳しすぎの両方向の問題がある。

**基準が緩すぎる場合**: 関連があるだけで前提にしてしまう。不要な制約が増え、ゲーム内の探索の自由度を損なう。
- 例:「スープの味が重要」→「スープに思い入れがある？」を前提関係とする — 関連はあるが、味の重要性を知らなくても思い入れについて聞ける。これを前提にすると質問の開放が不必要に遅れる

**基準が厳しすぎる場合**: 明らかな論理的不可能性しか前提にしない。前提にすべきものを見逃し、文脈なしに質問が開いてしまう。
- 例:「過去に食べたスープと味が違った？」に前提を設定しない — 過去に食べた事実が確定していない段階でこの質問が開くと、プレイヤーにとって唐突になる

## 具体例（ウミガメのスープ）

### 例 1: 過去の味との比較

「過去に食べたスープと今回の味は違いましたか？」

- 前提: Fs-26（男は以前にもウミガメのスープを食べたことがある）
- 根拠: 過去に食べた経験が確定していなければ、比較を問うこと自体が成立しない

### 例 2: 出来事の詳細

「その出来事で誰かが亡くなりましたか？」

- 前提: Fs-61（男の過去に重大な出来事があった）
- 根拠: 重大な出来事の存在が確定していなければ、その内容を掘り下げる質問は成立しない

### 非例（前提にすべきでないもの）

- 「スープの味が重要？」→「スープに思い入れがある？」：関連はあるが論理的に独立
- 「レストランに目的がある？」→「過去の体験と関係？」：緩やかな関連であり前提ではない

## 未決事項

1. **既存の偶然の開き構造との整理**: 前提事実の導入により、effect に開放記述素を追加する必要性が減るか
2. **適用範囲**: 全質問に前提事実を付けるか、必要な質問のみか
3. **強度の基準**: 「論理的に成立しない」の判断基準をどう定めるか

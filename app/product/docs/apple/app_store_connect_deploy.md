# App Store Connect デプロイ手順

## 前提条件

| 項目 | 要件 |
|------|------|
| Apple Developer Program | 登録済み（年額 $99） |
| Xcode | 16.x |
| macOS | Xcode 16 対応バージョン |
| Apple ID | Developer Program に紐づくアカウント |

## 1. 証明書とプロビジョニングプロファイルの準備

### 1.1 証明書の作成

Xcode の自動署名を利用する場合（推奨）:

1. Xcode でプロジェクトを開く
2. プロジェクトナビゲータ → ターゲット「LateralThinkingPuzzle」を選択
3. **Signing & Capabilities** タブを開く
4. **Automatically manage signing** にチェック
5. **Team** に Apple Developer アカウントを選択

> Xcode が Distribution 証明書とプロビジョニングプロファイルを自動生成する。

### 1.2 Bundle Identifier の確認

| 項目 | 値 |
|------|-----|
| Bundle Identifier | `com.kazuasato.LateralThinkingPuzzle` |
| Display Name | 水平思考パズル |

## 2. App Store Connect でアプリを登録

### 2.1 App Store Connect にアクセス

1. https://appstoreconnect.apple.com にサインイン
2. **マイ App** → **＋** → **新規 App**

### 2.2 アプリ情報の入力

| フィールド | 入力内容 |
|-----------|---------|
| プラットフォーム | iOS |
| 名前 | 水平思考パズル |
| プライマリ言語 | 日本語 |
| バンドル ID | Xcode で設定した Bundle Identifier を選択 |
| SKU | `lateral-thinking-puzzle`（任意の一意文字列） |
| アクセス | フルアクセス |

### 2.3 App Store 掲載情報の準備

以下を事前に用意する:

**スクリーンショット（必須）**:

| デバイス | サイズ | 必要枚数 |
|---------|-------|---------|
| iPhone 6.7インチ | 1290 x 2796 px | 最低1枚（推奨3〜5枚） |
| iPhone 6.5インチ | 1242 x 2688 px | 最低1枚（推奨3〜5枚） |

> Simulator で各画面のスクリーンショットを撮影する。
> パズル一覧画面、ゲーム画面、クリア画面を含める。

**テキスト情報**:

| 項目 | 内容 | 文字数上限 |
|------|------|-----------|
| App 名 | 水平思考パズル | 30文字 |
| サブタイトル | ウミガメのスープで論理的思考を鍛える | 30文字 |
| 説明文 | アプリの詳細説明 | 4000文字 |
| キーワード | パズル,水平思考,ウミガメのスープ,推理,謎解き | 100文字（カンマ区切り） |
| サポート URL | サポートページの URL | 必須 |
| プライバシーポリシー URL | プライバシーポリシーページの URL | 必須 |

**その他**:

| 項目 | 内容 |
|------|------|
| カテゴリ | ゲーム → パズル |
| 年齢制限 | 4+（暴力・性的コンテンツなし） |
| 価格 | 無料 |
| App アイコン | 1024 x 1024 px（アルファチャンネルなし） |

## 3. On-Demand Resources (ODR) の設定

本アプリは ODR でパズルコンテンツを配信するため、追加の設定が必要。

### 3.1 ODR タグの設定（Xcode）

1. プロジェクトナビゲータでリソースファイルを選択
2. **File Inspector** → **On Demand Resource Tags** にタグを設定

| タグ種別 | 用途 | 例 |
|---------|------|-----|
| Initial Install Tags | 初期同梱パズル | `puzzle_initial` |
| Prefetch Tag Order | 優先ダウンロード | `puzzle_pack_1` |
| Download Only On Demand | 追加コンテンツ | `puzzle_pack_2`, `puzzle_pack_3` |

### 3.2 App Store Connect での ODR ホスティング

- ODR コンテンツは Archive アップロード時に自動的に App Store にホスティングされる
- 追加の設定は不要（Apple が自動管理）

## 4. Archive の作成とアップロード

### 4.1 ビルド設定の確認

1. Xcode でスキームを **Any iOS Device (arm64)** に変更
2. **Product** → **Scheme** → **Edit Scheme** → **Run** の Build Configuration が **Release** であることを確認

### 4.2 バージョン番号の設定

| 項目 | 説明 | 例 |
|------|------|----|
| Version (CFBundleShortVersionString) | ユーザーに表示されるバージョン | `1.0.0` |
| Build (CFBundleVersion) | ビルド番号（アップロードごとに増加） | `1` |

### 4.3 Archive の作成

1. **Product** → **Archive**
2. ビルド完了後、**Organizer** ウィンドウが開く

### 4.4 App Store Connect へアップロード

1. Organizer で作成した Archive を選択
2. **Distribute App** をクリック
3. **App Store Connect** を選択
4. **Upload** を選択
5. 署名オプション: **Automatically manage signing**（推奨）
6. **Upload** をクリック

> アップロード完了後、App Store Connect の処理（数分〜数十分）を待つ。

### 4.5 Xcode Cloud（代替手段）

手動アップロードの代わりに Xcode Cloud で CI/CD を構成することも可能:

1. Xcode → **Product** → **Xcode Cloud** → **Create Workflow**
2. ブランチトリガー（例: `main` への push）を設定
3. Archive アクション → App Store Connect への自動アップロード

## 5. TestFlight でのテスト

### 5.1 内部テスト

1. App Store Connect → **TestFlight** タブ
2. アップロードしたビルドが表示されるまで待機
3. **内部テスト** グループを作成（チームメンバー最大100人）
4. テスターを追加 → 自動で招待メールが送信される

### 5.2 外部テスト

1. **外部テスト** グループを作成
2. ビルドを選択 → **Beta App Review に提出**
3. Apple の審査通過後（通常24時間以内）、外部テスターに配信可能
4. 外部テスターは最大10,000人

### 5.3 テスト確認項目

| 確認項目 | 内容 |
|---------|------|
| 起動 | アプリが正常に起動するか |
| パズル一覧 | パズルが正しく表示されるか |
| ゲームプレイ | 質問選択・回答表示が正常か |
| クリア | クリア画面が正しく表示されるか |
| ODR | パズルのダウンロード・プレイが正常か |
| 各デバイス | 対象 iPhone で表示が崩れないか |

## 6. App Store 審査への提出

### 6.1 提出前チェックリスト

- [ ] スクリーンショットが全サイズ分アップロード済み
- [ ] 説明文・キーワード等のメタデータが入力済み
- [ ] サポート URL が有効
- [ ] プライバシーポリシー URL が有効
- [ ] App アイコンが設定済み
- [ ] 年齢制限の設定が適切
- [ ] ビルドが選択済み
- [ ] App Privacy（プライバシー情報）が入力済み

### 6.2 App Privacy の設定

本アプリの初期リリースでは:

| 項目 | 回答 |
|------|------|
| データ収集 | データを収集しない |

> 将来 Analytics や課金を導入する場合は更新が必要。

### 6.3 審査への提出

1. App Store Connect → **App Store** タブ
2. 提出するバージョンのページで全項目を入力
3. **審査に追加** をクリック
4. **送信** をクリック

### 6.4 審査のタイムライン

| 段階 | 所要時間（目安） |
|------|----------------|
| 審査待ち | 数時間〜1日 |
| 審査中 | 通常24〜48時間 |
| リジェクト時の再提出 | 修正後に再提出、再度審査待ち |

### 6.5 よくあるリジェクト理由と対策

| 理由 | 対策 |
|------|------|
| メタデータの不備 | スクリーンショット・説明文の正確性を確認 |
| バグ・クラッシュ | TestFlight で十分にテスト |
| プライバシーポリシーの不備 | URL が有効で内容が適切か確認 |
| 最小機能要件 | アプリとして十分な機能があるか確認 |
| UIの不備 | Human Interface Guidelines に準拠しているか確認 |

## 7. リリース

### 7.1 リリース方法の選択

| 方法 | 説明 |
|------|------|
| 手動リリース | 審査通過後、自分のタイミングでリリース |
| 自動リリース | 審査通過後、即座にリリース |
| 段階的リリース | 7日間かけて段階的にユーザーに配信 |

> 初回リリースは **手動リリース** を推奨。審査通過を確認してからリリースする。

### 7.2 リリース後の確認

- [ ] App Store でアプリが検索・表示されるか
- [ ] ダウンロード・インストールが正常か
- [ ] ODR コンテンツのダウンロードが正常か

## 8. アップデート手順

1. バージョン番号を更新（Version + Build）
2. Archive → アップロード
3. App Store Connect で新バージョンのメタデータを入力
4. 審査に提出
5. 審査通過後にリリース

> ODR コンテンツのみの追加は、アプリバイナリの更新が必要。
> 新しいパズルを追加する場合もアプリの再 Archive・再提出が必要。
